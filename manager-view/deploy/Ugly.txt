<!DOCTYPE html>
<html>
<head>
    <title>CATS-timesheet-with-approval (manager-view)-2.0.4</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Fri May 11 2018 18:59:27 GMT+0000 (UTC) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Fri May 11 2018 18:59:27 GMT+0000 (UTC)";
        var ARTIFACT = "";
        var BUILDER  = "ec2-user";
        var CHECKSUM = 437718979123;
    </script>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns)
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->


    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("TSUtilities",{singleton:!0,timeLockKeyPrefix:"rally.technicalservices.timesheet.weeklock",approvalKeyPrefix:"rally.technicalservices.timesheet.status",deletionKeyPrefix:"rally.technicalservices.timesheet.deletion",pinKeyPrefix:"rally.technicalservices.timesheet.pin",archiveSuffix:"~archived",lowestPortfolioItemTypeName:void 0,lowestPortfolioItemTypeNameSettingField:{name:"lowestPortfolioItemTypeName",xtype:"rallyportfolioitemtypecombobox",fieldLabel:"Lowest Level Portfolio Item Type Name",valueField:"Name"},fetchManagerPortfolioItemFields:[],fetchManagerPortfolioItemFieldsSettingField:{name:"fetchManagerPortfolioItemFields",xtype:"rallyfieldcombobox",allowBlank:!0,allowNoEntry:!0,fieldLabel:"Extra Portfolio Item Fields"},loadWsapiRecords:function(a,b){var c=Ext.create("Deft.Deferred"),d={model:"Defect",fetch:["ObjectID"]};return Ext.create("Rally.data.wsapi.Store",Ext.Object.merge(d,a)).load({callback:function(a,d,e){e?b?c.resolve(d):c.resolve(a):c.reject("Problem loading: "+d.error.errors.join(". "))}}),c.promise},loadWsapiRecordsWithParallelPages:function(a,b){var c=Ext.create("Deft.Deferred"),d=this,e=Ext.clone(a);return e.limit=1,e.pageSize=1,e.fetch=["ObjectID"],this.loadWsapiRecords(e,!0).then({success:function(e){a.pageSize=200,a.limit=a.pageSize;var f=e.resultSet.totalRecords,g=Math.ceil(f/a.pageSize),h=[];Ext.Array.each(_.range(1,g+1),function(c){var e=Ext.clone(a);e.currentPage=c,h.push(function(){var a=parseInt(100*c/g,10),f=b||"Loading values";return Rally.getApp().setLoading(f+" ("+a+"%)"),d.loadWsapiRecords(e)})}),CA.techservices.promise.ParallelThrottle.throttle(h,6,d).then({success:function(a){c.resolve(Ext.Array.flatten(a))},failure:function(a){c.reject(a)}})},failure:function(a){c.reject(a)}}),c.promise},getPreferenceProject:function(){var a=Rally.getApp();return a.getSetting("preferenceProjectRef")},isEditableProjectForCurrentUser:function(a,b){var c=b||Rally.getApp(),d=this;if(this.currentUserIsAdmin(b))return!0;var e=this._getOidFromRef(a),f=Ext.Array.filter(c.getContext().getPermissions().userPermissions,function(a){return"Editor"!=a.Role&&"ProjectAdmin"!=a.Role?!1:d._getOidFromRef(a._ref)==e});return f.length>0},getEditableProjectForCurrentUser:function(){var a=Rally.getApp();if(this._currentUserCanWrite())return a.getContext().getProjectRef();var b=this._getOidFromRef(a.getContext().getWorkspaceRef()),c=Ext.Array.filter(a.getContext().getPermissions().userPermissions,function(a){if(Ext.isEmpty(a.Workspace))return!1;var c=this._getOidFromRef(a.Workspace);return b!=c?!1:"Editor"==a.Role||"ProjectAdmin"==a.Role},this);return c.length>0?c[0]._ref:!1},_getOidFromRef:function(a){var b=a.replace(/\.js$/,"").split(/\//);return b[b.length-1].replace(/\.js/,"")},currentUserIsAdmin:function(a){var b=a||Rally.getApp();if(this.currentUserIsSubAdmin())return!0;var c=b.getContext().getPermissions().userPermissions,d=Ext.Array.filter(c,function(a){return"Workspace Admin"==a.Role||"Subscription Admin"==a.Role}),e=this._getOidFromRef(b.getContext().getWorkspace()._ref),f=!1;return d.length>0&&Ext.Array.each(d,function(a){e==this._getOidFromRef(a._ref)&&(f=!0)},this),f},currentUserIsSubAdmin:function(a){var b=a||Rally.getApp(),c=b.getContext().getPermissions().userPermissions,d=Ext.Array.filter(c,function(a){return"Subscription Admin"==a.Role});return d.length>0},_currentUserCanWrite:function(){var a=Rally.getApp();if(a.getContext().getUser().SubscriptionAdmin)return!0;var b=a.getContext().getPermissions().userPermissions,c=Ext.Array.filter(b,function(a){return"Workspace Admin"==a.Role||"Subscription Admin"==a.Role}),d=this._getOidFromRef(a.getContext().getWorkspace()._ref),e=!1;return c.length>0&&Ext.Array.each(c,function(a){d==this._getOidFromRef(a._ref)&&(e=!0)},this),e},_currentUserCanProcess:function(){return this.currentUserIsAdmin()},_currentUserCanUnprocess:function(){return this.currentUserIsAdmin()},groupTimeEntryItemsByWorkProduct:function(a){return _.groupBy(a,function(a){var b,c=a.get("Task"),d=a.get("WorkProduct");if(!Ext.isEmpty(d)){var b=d.ObjectID;Ext.isEmpty(c)||(b=c.ObjectID)}return b})}}),Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){return text=a.responseText,CHECKSUM&&CHECKSUM!==c._generateChecksum(text)?void b.resolve(!1):void b.resolve(!0)}}),b.promise},afterRender:function(){var a=Rally.getApp();a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){}}),this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml}),this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"This app was created by the Rally Technical Services Team."}),APP_BUILD_DATE&&this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"Build date/time: "+APP_BUILD_DATE})}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("CA.techservices.promise.ParallelThrottle",{requires:["Deft.promise.Promise"],statics:{throttle:function(a,b,c){if(0>=b||a.length<b)return Deft.promise.Chain.parallel(a,c);for(var d=[],e=[],f=-1,g=0;g<a.length;g++)g%b===0&&(f++,e[f]=[]),e[f].push(a[g]);return _.each(e,function(a){d.push(function(){return Deft.promise.Chain.parallel(a,c)})}),Deft.Promise.reduce(d,function(a,b){return Deft.Promise.when(b.call(c)).then(function(b){return a=a.concat(b||[])})},[])}}}),Ext.define("TSDateUtils",{singleton:!0,startDayOfWeek:"Sunday",getDaysOfWeek:_.memoize(function(){var a=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],b=_.findIndex(a,function(a){return a===this.startDayOfWeek},this);return-1===b&&(b=0),a.slice(b).concat(a.slice(0,b))},function(){return this.startDayOfWeek}),getUtcSundayWeekStartStrings:function(a){var b=Ext.Date.add(a,Ext.Date.MINUTE,a.getTimezoneOffset()),c=this.getBeginningOfWeekForLocalDate(b);if(0===c.getDay())return[this.getUtcIsoForLocalDate(c,!0)];var d=Ext.Date.add(a,Ext.Date.DAY,-1*c.getDay()),e=Ext.Date.add(a,Ext.Date.DAY,7-c.getDay());return[this.getUtcIsoForLocalDate(d,!0),this.getUtcIsoForLocalDate(e,!0)]},getBeginningOfWeekForLocalDate:function(a){var b=Ext.Date.format(a,"l"),c=this.getDaysOfWeek(),d=c.indexOf(b),e=Ext.Date.add(a,Ext.Date.DAY,-1*d);return e},getUtcIsoForLocalDate:function(a,b){var c=Ext.Date.add(a,Ext.Date.MINUTE,a.getTimezoneOffset()),d=Ext.Date.format(c,"Y-m-d");return b&&(d+="T00:00:00.000Z"),d},formatShiftedDate:function(a,b){var c=a.getTimezoneOffset();return c>0&&(a=Rally.util.DateTime.add(a,"minute",c)),Ext.util.Format.date(a,b)},isApproved:function(a,b){var c=Ext.create("Deft.Deferred"),d=a,e=b||Rally.getApp().getContext().getUser().ObjectID,f=Ext.String.format("{0}.{1}.{2}",TSUtilities.approvalKeyPrefix,d,e);return this._loadWeekStatusPreference(f).then({success:function(a){if(0===a.length)return void c.resolve(!1);var b=a[0].get("Value");if(/{/.test(b)){var d=Ext.JSON.decode(b);if(d.status==TSTimesheet.STATUS.APPROVED)return void c.resolve(!0)}c.resolve(!1)},failure:function(a){c.reject(a)}}),c.promise},_loadWeekStatusPreference:function(a){var b={model:"Preference",limit:1,pageSize:1,filters:[{property:"Name",operator:"contains",value:a},{property:"Name",operator:"!contains",value:TSUtilities.archiveSuffix}],fetch:["Name","Value"],sorters:[{property:"CreationDate",direction:"DESC"}]};return TSUtilities.loadWsapiRecords(b)}}),Ext.define("recordHolder",{data:{},constructor:function(a){Ext.apply(this,a)},get:function(a){return this.data[a]}}),Ext.define("Rally.technicalservices.FileUtilities",{singleton:!0,logger:new Rally.technicalservices.Logger,saveCSVToFile:function(a,b,c){void 0===c&&(c={type:"text/csv;charset=utf-8"}),this.saveAs(a,b,c)},saveAs:function(a,b){if(Ext.isIE9m)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});var c=null;try{c=new Blob([a],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&(bb=new BlobBuilder,bb.append([a]),c=bb.getBlob("text/plain"))}if(!c)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."});var e=b;if(Ext.isIE10p)return void window.navigator.msSaveOrOpenBlob(c,e);var f=this.createObjectURL(c);if(f){var g=document.createElement("a");"download"in g?g.download=e:g.target="_blank",g.innerHTML="Download File",g.href=f,Ext.isChrome||(g.onclick=this.destroyClickedElement,g.style.display="none",document.body.appendChild(g)),g.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})},createObjectURL:function(a){return window.webkitURL?window.webkitURL.createObjectURL(a):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):null},saveTextAsFile:function(a,b){var c=new Blob([a],{type:"text/plain"}),d=b,e=document.createElement("a");e.download=d,e.innerHTML="Download File",null!=window.webkitURL?e.href=window.webkitURL.createObjectURL(c):(e.href=window.URL.createObjectURL(c),e.onclick=destroyClickedElement,e.style.display="none",document.body.appendChild(e)),e.click()},destroyClickedElement:function(a){document.body.removeChild(a.target)},convertDataArrayToCSVText:function(a,b){var c="";return Ext.each(Object.keys(b),function(a){c+=b[a]+","}),c=c.replace(/,$/,"\n"),Ext.each(a,function(a){Ext.each(Object.keys(b),function(b){c+=a[b]?"object"==typeof a[b]?a[b].FormattedID?Ext.String.format('"{0}",',a[b].FormattedID):a[b].Name?Ext.String.format('"{0}",',a[b].Name):isNaN(Date.parse(a[b]))?Ext.String.format('"{0}",',a[b].toString()):Ext.String.format('"{0}",',Rally.util.DateTime.formatWithDefaultDateTime(a[b])):Ext.String.format('"{0}",',a[b]):","},this),c=c.replace(/,$/,"\n")},this),c},_getCSVFromWsapiBackedGrid:function(a,b){for(var c=Ext.create("Deft.Deferred"),d=Ext.create("Rally.data.wsapi.Store",{fetch:a.getStore().config.fetch,filters:a.getStore().config.filters,model:a.getStore().config.model,pageSize:200}),e=a.columns,f=a.getStore().getTotalCount(),g=a.getStore().pageSize,h=Math.ceil(f/g),i=[],j=1;h>=j;j++)i.push(this.loadStorePage(a,d,e,j,h));return Deft.Promise.all(i).then({success:function(d){var e=[];b||e.push('"'+this._getHeadersFromGrid(a).join('","')+'"'),_.each(d,function(a){_.each(a,function(a){e.push(a)})}),e=e.join("\r\n"),c.resolve(e),Rally.getApp().setLoading(!1)}}),c.promise},getCSVFromRows:function(a,b,c){var d=this,e=(b.columns,b.getStore()),f=(b.model,[]);return f.push('"'+this._getHeadersFromGrid(b).join('","')+'"'),Ext.Array.each(c,function(a){f.push(d._getCSVFromRecord(a,b,e))}),f=f.join("\r\n")},_getCSVFromCustomBackedGrid:function(a,b){var c=Ext.create("Deft.Deferred"),d=Ext.clone(a.getStore()),e=a.columns;Rally.getApp().setLoading("Generating CSV...");for(var f=d.getTotalCount(),g=d.pageSize,h=Math.ceil(f/g),i=[],j=1;h>=j;j++)i.push(this.loadStorePage(a,d,e,j,h));return Deft.Promise.all(i).then({scope:this,success:function(d){var e=[];b||e.push('"'+this._getHeadersFromGrid(a).join('","')+'"'),_.each(d,function(a){_.each(a,function(a){e.push(a)})}),e=e.join("\r\n"),c.resolve(e),Rally.getApp().setLoading(!1)}}),c.promise},_getHeadersFromGrid:function(a){var b=[],c=a.columns;return Ext.Array.each(c,function(a){a.hidden||(a.dataIndex||a.renderer)&&(a.csvText?b.push(a.csvText.replace("&nbsp;"," ")):a.text&&b.push(a.text.replace("&nbsp;"," ")))}),b},_getColumnNamesFromGrid:function(a){var b=[],c=a.columns;return Ext.Array.each(c,function(a){(a.dataIndex||a.renderer)&&b.push(a.dataIndex)}),b},getCSVFromGrid:function(a,b,c){return"Rally.data.custom.Store"!=Ext.getClassName(b.getStore())?this._getCSVFromWsapiBackedGrid(b,c):this._getCSVFromCustomBackedGrid(b,c)},loadStorePage:function(a,b,c,d,e){var f=Ext.create("Deft.Deferred");return b.loadPage(d,{callback:function(c){var g=[];Rally.getApp().setLoading(Ext.String.format("Page {0} of {1} loaded",d,e));for(var h=0;h<c.length;h++){var i=c[h];g.push(this._getCSVFromRecord(i,a,b))}f.resolve(g)},scope:this}),f},_getCSVFromRecord:function(a,b,c){var d={align:"right",classes:[],cellIndex:9,column:null,columnIndex:9,innerCls:void 0,recordIndex:5,rowIndex:5,style:"",tdAttr:"",tdCls:"x-grid-cell x-grid-td x-grid-cell-headerId-gridcolumn-1029 x-grid-cell-last x-unselectable",unselectableAttr:"unselectable='on'"},e=[],f=b.columns;Ext.Array.each(f,function(f){if("rallyrowactioncolumn"!=f.xtype&&"tsrowactioncolumn"!=f.xtype&&!f.hidden&&!f._csvIgnoreRender)if(f.dataIndex){var g=f.dataIndex,h=a.get(g);(f.renderer||f.exportRenderer)&&(h=f.exportRenderer?f.exportRenderer(h,d,a,0,0,c,b.getView()):f.renderer(h,d,a,0,0,c,b.getView())),e.push(h)}else{var h=null;f.renderer&&(h=f.exportRenderer?f.exportRenderer(h,d,a,a,0,0,c,b.getView()):f.renderer(h,d,a,a,0,0,c,b.getView()),e.push(h))}},this);var g="";return Ext.Array.each(e,function(a,b){b>0&&(g+=","),/^=/.test(a)?g+=a:g=g+'"'+a+'"'}),g}}),function(a){"use strict";if(a.URL=a.URL||a.webkitURL,a.Blob&&a.URL)try{return void new Blob}catch(b){}var c=a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||function(a){var b=function(a){return Object.prototype.toString.call(a).match(/^\[object\s(.*)\]$/)[1]},c=function(){this.data=[]},d=function(a,b,c){this.data=a,this.size=a.length,this.type=b,this.encoding=c},e=c.prototype,f=d.prototype,g=a.FileReaderSync,h=function(a){this.code=this[this.name=a]},i="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),j=i.length,k=a.URL||a.webkitURL||a,l=k.createObjectURL,m=k.revokeObjectURL,n=k,o=a.btoa,p=a.atob,q=a.ArrayBuffer,r=a.Uint8Array;for(d.fake=f.fake=!0;j--;)h.prototype[i[j]]=j+1;return k.createObjectURL||(n=a.URL={}),n.createObjectURL=function(a){var b,c=a.type;return null===c&&(c="application/octet-stream"),a instanceof d?(b="data:"+c,"base64"===a.encoding?b+";base64,"+a.data:"URI"===a.encoding?b+","+decodeURIComponent(a.data):o?b+";base64,"+o(a.data):b+","+encodeURIComponent(a.data)):l?l.call(k,a):void 0},n.revokeObjectURL=function(a){"data:"!==a.substring(0,5)&&m&&m.call(k,a)},e.append=function(a){var c=this.data;if(r&&(a instanceof q||a instanceof r)){for(var e="",f=new r(a),i=0,j=f.length;j>i;i++)e+=String.fromCharCode(f[i]);c.push(e)}else if("Blob"===b(a)||"File"===b(a)){if(!g)throw new h("NOT_READABLE_ERR");var k=new g;c.push(k.readAsBinaryString(a))}else a instanceof d?"base64"===a.encoding&&p?c.push(p(a.data)):"URI"===a.encoding?c.push(decodeURIComponent(a.data)):"raw"===a.encoding&&c.push(a.data):("string"!=typeof a&&(a+=""),c.push(unescape(encodeURIComponent(a))))},e.getBlob=function(a){return arguments.length||(a=null),new d(this.data.join(""),a,"raw")},e.toString=function(){return"[object BlobBuilder]"},f.slice=function(a,b,c){var e=arguments.length;return 3>e&&(c=null),new d(this.data.slice(a,e>1?b:this.data.length),c,this.encoding)},f.toString=function(){return"[object Blob]"},f.close=function(){this.size=0,delete this.data},c}(a);a.Blob=function(a,b){var d=b?b.type||"":"",e=new c;if(a)for(var f=0,g=a.length;g>f;f++)e.append(a[f]);return e.getBlob(d)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this);var saveAs=saveAs||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(a){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=b.createElementNS("http://www.w3.org/1999/xhtml","a"),e=!a.externalHost&&"download"in d,f=function(c){var d=b.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d)},g=a.webkitRequestFileSystem,h=a.requestFileSystem||g||a.mozRequestFileSystem,i=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},j="application/octet-stream",k=0,l=[],m=function(){for(var a=l.length;a--;){var b=l[a];"string"==typeof b?c().revokeObjectURL(b):b.remove()}l.length=0},n=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(f){i(f)}}},o=function(b,i){var m,o,p,q=this,r=b.type,s=!1,t=function(){var a=c().createObjectURL(b);return l.push(a),a},u=function(){n(q,"writestart progress write writeend".split(" "))},v=function(){(s||!m)&&(m=t(b)),o?o.location.href=m:window.open(m,"_blank"),q.readyState=q.DONE,u()},w=function(a){return function(){return q.readyState!==q.DONE?a.apply(this,arguments):void 0}},x={create:!0,exclusive:!1};return q.readyState=q.INIT,i||(i="download"),e?(m=t(b),d.href=m,d.download=i,f(d),q.readyState=q.DONE,void u()):(a.chrome&&r&&r!==j&&(p=b.slice||b.webkitSlice,b=p.call(b,0,b.size,j),s=!0),g&&"download"!==i&&(i+=".download"),(r===j||g)&&(o=a),h?(k+=b.size,void h(a.TEMPORARY,k,w(function(a){a.root.getDirectory("saved",x,w(function(a){var c=function(){a.getFile(i,x,w(function(a){a.createWriter(w(function(c){c.onwriteend=function(b){o.location.href=a.toURL(),l.push(a),q.readyState=q.DONE,n(q,"writeend",b)},c.onerror=function(){var a=c.error;a.code!==a.ABORT_ERR&&v()},"writestart progress write abort".split(" ").forEach(function(a){c["on"+a]=q["on"+a]}),c.write(b),q.abort=function(){c.abort(),q.readyState=q.DONE},q.readyState=q.WRITING}),v)}),v)};a.getFile(i,{create:!1},w(function(a){a.remove(),c()}),w(function(a){a.code===a.NOT_FOUND_ERR?c():v()}))}),v)}),v)):void v())},p=o.prototype,q=function(a,b){return new o(a,b)};return p.abort=function(){var a=this;a.readyState=a.DONE,n(a,"abort")},p.readyState=p.INIT=0,p.WRITING=1,p.DONE=2,p.error=p.onwritestart=p.onprogress=p.onwrite=p.onabort=p.onerror=p.onwriteend=null,a.addEventListener("unload",m,!1),q.unload=function(){m(),a.removeEventListener("unload",m,!1)},q}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&null!==module?module.exports=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),Ext.define("Rally.technicalservices.AbsorbTimeEntryMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.tsabsorbtimeentrymenuitem",config:{text:"Absorb Values",records:[]},constructor:function(a){a=a||{},a.predicate=a.predicate||this.shouldShowMenuItem,a.handler=a.handler||this._absorbRecords,this.initConfig(a),this.callParent([a])},shouldShowMenuItem:function(a){return!a.isLocked()},_absorbRecord:function(a){var b=this.view.ownerCt.ownerCt;b.absorbTime(a)},_absorbRecords:function(){var a=this.record,b=this.records;0===b.length&&(b=[a]),Ext.Array.each(b,function(a){this._absorbRecord(a)},this)}}),Ext.define("Rally.technicalservices.AlterTimeEntryMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.tsaltertimeentrymenuitem",config:{text:"Alter Values",records:[]},constructor:function(a){a=a||{},a.predicate=a.predicate||this.shouldShowMenuItem,a.handler=a.handler||this._alterRecords,this.initConfig(a),this.callParent([a])},shouldShowMenuItem:function(a){return!a.isLocked()},_alterRecord:function(a){var b=this.view.ownerCt.ownerCt;b.cloneForAppending(a)},_alterRecords:function(){var a=this.record,b=this.records;0===b.length&&(b=[a]),Ext.Array.each(b,function(a){this._alterRecord(a)},this)}}),Ext.override(Rally.ui.grid.CheckboxModel,{_recordIsSelectable:function(a){return!0}}),Ext.define("Rally.technicalservices.PinTimeEntryMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.tspintimeentrymenuitem",config:{text:"Set As Default",records:[]},constructor:function(a){a=a||{},a.predicate=a.predicate||this.shouldShowMenuItem,a.handler=a.handler||this._pinRecords,this.initConfig(a),this.callParent([a])},shouldShowMenuItem:function(a){return!a.isLocked()&&!a.isPinned()&&!a.isDeleted()},_pinRecord:function(a){var b=this.view.ownerCt.ownerCt;b.pinTime(a)},_pinRecords:function(){var a=this.record,b=this.records;0===b.length&&(b=[a]),Ext.Array.each(b,function(a){this._pinRecord(a)},this)}}),Ext.define("Rally.technicalservices.RemoveTimeEntryMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.tsremovetimeentrymenuitem",config:{text:"Clear & Remove",records:[]},constructor:function(a){a=a||{},a.predicate=a.predicate||this.shouldShowMenuItem,a.handler=a.handler||this._removeRecords,this.initConfig(a),this.callParent([a])},shouldShowMenuItem:function(a){return!a.isLocked()},_removeRecord:function(a){a.clearAndRemove()},_removeRecords:function(){var a=this.record,b=this.records;0===b.length&&(b=[a]),Ext.Array.each(b,function(a){this._removeRecord(a)},this)}}),Ext.define("Rally.technicalservices.TimeEntryRecordMenu",{extend:"Rally.ui.menu.RecordMenu",alias:"widget.tstimeentryrecordmenu",config:{record:null,owningEl:void 0,forModification:!1},initComponent:function(){this.items=this._getMenuItems(),this.callParent(arguments)},_getMenuItems:function(){var a=this.getRecord(),b=this.records||[],c=[];this.popoverPlacement||Rally.ui.popover.Popover.DEFAULT_PLACEMENT;return b&&b.length>0?c.push({xtype:"tsremovetimeentrymenuitem",view:this.view,record:a,records:b}):this.forModification?a.get("__Appended")||a.get("__Amended")?c.push({xtype:"tsremovetimeentrymenuitem",view:this.view,record:a}):c.push({xtype:"tsaltertimeentrymenuitem",view:this.view,record:a}):(c.push({xtype:"tsremovetimeentrymenuitem",view:this.view,record:a}),a.get("__Amended")||a.get("__Appended")?c.push({xtype:"tsabsorbtimeentrymenuitem",view:this.view,record:a}):(c.push({xtype:"tspintimeentrymenuitem",view:this.view,record:a}),c.push({xtype:"tsunpintimeentrymenuitem",view:this.view,record:a}))),c}}),Ext.define("Rally.technicalservices.UnpinTimeEntryMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.tsunpintimeentrymenuitem",config:{text:"Remove Default",records:[]},constructor:function(a){a=a||{},a.predicate=a.predicate||this.shouldShowMenuItem,a.handler=a.handler||this._unpinRecords,this.initConfig(a),this.callParent([a])},shouldShowMenuItem:function(a){return!a.isLocked()&&a.isPinned()&&!a.isDeleted()},_unpinRecord:function(a){var b=this.view.ownerCt.ownerCt;b.unpinTime(a)},_unpinRecords:function(){var a=this.record,b=this.records;0===b.length&&(b=[a]),Ext.Array.each(b,function(a){this._unpinRecord(a)},this)}}),Ext.define("Rally.technicalservices.grid.TimeTableRowActionColumn",{extend:"Ext.grid.column.Column",alias:"widget.tstimetablerowactioncolumn",inheritableStatics:{getRequiredFetchFields:function(a){return a.enableBulkEdit&&["Project","Tags"]||[]}},sortable:!1,hideable:!1,resizable:!1,draggable:!1,menuDisabled:!0,forModification:!1,flex:-1,minWidth:Ext.isIE9?22:26,maxWidth:Ext.isIE9?22:26,printable:!1,tdCls:"rally-cell-row-action",cls:"row-action-column-header",config:{rowActionsFn:null,scope:null,canUnlock:!1},constructor:function(){this.callParent(arguments),this.renderer=this._renderGearIcon},initComponent:function(){this.callParent(arguments),this.on("click",this._showMenu,this)},onDestroy:function(){this.menu&&(this.menu.destroy(),delete this.menu),this.callParent(arguments)},_renderGearIcon:function(a,b,c){return b.tdCls=Rally.util.Test.toBrowserTestCssClass("row-action",Rally.util.Ref.getOidFromRef(c.get("_ref"))),'<div class="row-action-icon icon-gear"/>'},_showMenu:function(a,b){var c,d=a.getRecord(Ext.fly(b).parent("tr")),e=a.getSelectionModel().getSelection();a.panel;c={view:a,record:d,records:e,owningEl:b.parentElement,popoverPlacement:["bottom","top"],canUnlock:this.canUnlock,forModification:this.forModification},this.rowActionsFn?this.menu=Ext.create("Rally.technicalservices.TimeEntryRecordMenu",Ext.apply({items:this.rowActionsFn.call(this.scope||this,d)},c)):this.menu=this._getDefaultRecordMenu(d,c),this.menu.showBy(Ext.fly(b).down(".row-action-icon"))},_getDefaultRecordMenu:function(a,b){var c=Ext.merge(b,this.menuOptions||{});return Ext.create("Rally.technicalservices.TimeEntryRecordMenu",c)}}),Ext.define("Rally.technicalservices.CommentDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tscommentdialog",height:400,width:600,layout:"fit",closable:!0,draggable:!0,config:{title:"Timesheet Comments",keyPrefix:null,preferences:null,defaultFocus:"comment_field"},constructor:function(a){if(this.mergeConfig(a),Ext.isEmpty(this.config.keyPrefix))throw"keyPrefix is required for the Comment Dialog";if(!Ext.isArray(this.config.preferences))throw"preferences is required for the Comment Dialog";this.callParent([this.config])},initComponent:function(){this.callParent(arguments),this.addEvents("commentAdded","commentRemoved")},beforeRender:function(){this.callParent(arguments),this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",text:"Close",cls:"secondary rly-small",handler:this.close,scope:this,ui:"link"}]}),this.addDocked({xtype:"toolbar",itemId:"add_box",dock:"top",border:!1,padding:2,items:this._getAddBoxItems()}),this.buildGrid()},_getColumns:function(){var a=[],b=TSUtilities.currentUserIsAdmin();return b&&a.push({xtype:"tscommentrowactioncolumn",rowActionsFn:function(a,b){return[{text:"Remove",record:a,view:b,handler:function(){var a=this.record,b=this.record.get("Preference");b&&(this.view&&this.view.getStore()&&(this.view.getStore().remove(a),this.view.getStore().fireEvent("recordRemoved",this.view.getStore(),a)),b.destroy())}}]}}),Ext.Array.push(a,[{dataIndex:"User",text:"User"},{dataIndex:"Comment",text:"Comment",flex:1},{dataIndex:"CreationDate",text:"Posted",renderer:function(a){return Ext.util.Format.date(a,"n/j/Y, g:i a")}}])},buildGrid:function(){this.grid&&this.grid.destroy();var a=Ext.Array.map(this.preferences,function(a){var b=Ext.JSON.decode(a.get("Value"));return{Comment:b.text,User:b.user._refObjectName,CreationDate:a.get("CreationDate"),Preference:a}}),b=Ext.create("Rally.data.custom.Store",{data:a,sorters:[{property:"CreationDate",direction:"DESC"}],listeners:{scope:this,recordRemoved:function(a,b){this.fireEvent("commentRemoved",this,b.get("Preference"))}}});this.grid=Ext.create("Rally.ui.grid.Grid",{columnCfgs:this._getColumns(),enableEditing:!1,enableColumnHide:!1,enableColumnMove:!1,showRowActionsColumn:!1,showPagingToolbar:!1,store:b}),this.add(this.grid)},_getAddBoxItems:function(){var a=TSUtilities.getEditableProjectForCurrentUser(),b="Posting requires Edit rights in at least one project";return a===!1||Ext.isEmpty(a)||(a=!0,b="Submit Comment"),[{xtype:"rallytextfield",itemId:"comment_field",flex:1,margin:5},{xtype:"rallybutton",text:"Post",disabled:!a,toolTipText:b,listeners:{scope:this,click:this._postComment}}]},_postComment:function(){var a=this.down("#comment_field"),b=a.getValue();if(!Ext.isEmpty(b)&&!Ext.isEmpty(Ext.String.trim(b))){a.setValue("");var c=Rally.getApp().getContext().getUser(),d={text:b,user:{_type:"User",_ref:c._ref,_refObjectName:c._refObjectName,ObjectID:c.ObjectID}},e=Ext.String.format("{0}.{1}",this.keyPrefix,Ext.util.Format.date(new Date,"time"));this._makePreference(e,Ext.JSON.encode(d)).then({scope:this,success:function(a){Ext.Array.push(this.preferences,a),this.buildGrid()},failure:function(a){Ext.Msg.alert("Cannot Create Comment",a)}})}},_makePreference:function(a,b){var c=Ext.create("Deft.Deferred"),d=this;return Rally.data.ModelFactory.getModel({type:"Preference",success:function(e){var f={Name:a,Value:b,Project:TSUtilities.getEditableProjectForCurrentUser()},g=Ext.create(e,f);g.save({callback:function(a,b){b.wasSuccessful()?(d.fireEvent("commentAdded",this,a),c.resolve([a])):c.reject(b.error.errors[0])}})}}),c.promise}}),Ext.define("Rally.technicalservices.grid.comments.RowActionColumn",{extend:"Ext.grid.column.Column",alias:"widget.tscommentrowactioncolumn",sortable:!1,hideable:!1,resizable:!1,draggable:!1,menuDisabled:!0,flex:-1,minWidth:Ext.isIE9?22:26,maxWidth:Ext.isIE9?22:26,printable:!1,tdCls:"rally-cell-row-action",cls:"row-action-column-header",config:{rowActionsFn:null,scope:null,canUnlock:!1},constructor:function(){this.callParent(arguments),this.renderer=this._renderGearIcon},initComponent:function(){this.callParent(arguments),this.on("click",this._showMenu,this)},onDestroy:function(){this.menu&&(this.menu.destroy(),delete this.menu),this.callParent(arguments)},_renderGearIcon:function(a,b,c){return b.tdCls=Rally.util.Test.toBrowserTestCssClass("row-action",Rally.util.Ref.getOidFromRef(c.get("_ref"))),'<div class="row-action-icon icon-gear"/>'},_showMenu:function(a,b){var c,d=a.getRecord(Ext.fly(b).parent("tr")),e=a.getSelectionModel().getSelection();a.panel;if(c={view:a,record:d,records:e,owningEl:b.parentElement,popoverPlacement:["bottom","top"],canUnlock:this.canUnlock},this.rowActionsFn){var f=Ext.apply({items:this.rowActionsFn.call(this.scope||this,d,a)},c);this.menu=Ext.create("Rally.ui.menu.Menu",f)}else this.menu=this._getDefaultRecordMenu(d,c);this.menu.showBy(Ext.fly(b).down(".row-action-icon"))},_getDefaultRecordMenu:function(a,b){var c=Ext.merge(b,this.menuOptions||{});return Ext.create("Rally.technicalservices.RecordMenu",c)}}),Ext.define("Rally.technicalservices.ChooserDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tschooserdialog",clientMetrics:[{beginEvent:"beforeshow",endEvent:"show",description:"dialog shown"}],width:800,closable:!0,searchContext:"project",config:{title:"Choose an Artifact",artifactTypes:[],multiple:!1,storeConfig:{},filterableFields:[],columns:[],fetchFields:[],selectionButtonText:"Done",gridConfig:{},selectedRef:void 0},items:{xtype:"panel",border:!1,items:[{xtype:"container",itemId:"gridContainer",layout:"fit",height:400}]},constructor:function(a){this.mergeConfig(a),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),this.addEvents("artifactChosen"),this.addCls("chooserDialog"),this._buildButtons(),this._buildSearchBar(),Rally.data.ModelFactory.getModels({types:this.artifactTypes,success:function(a){this.artifactTypes.length>1&&this._setupComboBox(a),this._buildGrid(a[this.artifactTypes[0]])},scope:this})},_buildButtons:function(){this.down("panel").addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",text:this.selectionButtonText,cls:"primary small",scope:this,userAction:"clicked done in dialog",handler:function(){var a=this._getSelectedRecords();this.multiple||(a=a[0]),this.fireEvent("artifactChosen",this,a),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary small",handler:this.close,scope:this,ui:"link"}]})},_buildSearchBar:function(){var a=Ext.create("Ext.form.field.ComboBox",{itemId:"filterTypeComboBox",queryMode:"local",store:Ext.create("Ext.data.Store",{fields:["attributeName","displayName"],data:this.filterableFields}),displayField:"displayName",valueField:"attributeName",editable:!1});a.select(a.getStore().getAt(1)),this.addDocked({xtype:"toolbar",itemId:"searchBar",dock:"top",items:[a,{xtype:"textfield",itemId:"searchTerms",emptyText:"enter search terms",flex:1,enableKeyEvents:!0,listeners:{keyup:function(a,b){b.getKey()===Ext.EventObject.ENTER&&this._search();
},scope:this}},{xtype:"button",text:'<span class="icon-search"> </span>',handler:this._openSearchMenu,scope:this}]})},_setupComboBox:function(a){var b=this.down("#searchBar"),c=Ext.create("Ext.form.field.ComboBox",{xtype:"combo",name:"filterType",queryMode:"local",store:Ext.create("Ext.data.Store",{fields:["typeName","displayName","wsapiModel"]}),displayField:"displayName",valueField:"typeName",editable:!1});b.insert(0,c),Ext.Object.each(a,function(a,b){c.getStore().add({typeName:b.typePath,displayName:b.displayName,wsapiModel:b})},this),c.select(c.getStore().getAt(0)),c.on("select",function(a,b){var c=b[0];this.grid.reconfigureWithModel(c.get("wsapiModel"))},this)},_buildGrid:function(a){var b=this.multiple?"MULTI":"SINGLE";this.selectionModel=Ext.create("Rally.ui.selection.CheckboxModel",{mode:b,allowDeselect:!0});var c=this.storeConfig;c.context={project:Rally.getApp().getContext().getProjectRef()};var d=Ext.Array.merge(["ObjectID"],this.fetchFields),e=c.fetch||[];c.fetch=Ext.Array.merge(d,e);var f=Ext.Object.merge({model:a,selModel:this.selectionModel,autoAddAllModelFieldsAsColumns:!1,enableEditing:!1,enableColumnHide:!1,enableColumnMove:!1,columnCfgs:this.columns,storeConfig:c,showRowActionsColumn:!1,viewConfig:{emptyText:Rally.ui.EmptyTextFactory.get("defaultText")}},this.config.gridConfig);this.grid=Ext.create("Rally.ui.grid.Grid",f),this.mon(this.grid,"load",this._onGridLoad,this),this.down("#gridContainer").add(this.grid),this._onGridReady()},_onGridReady:function(){return this.grid.rendered?this.grid.getStore().isLoading()?void this.mon(this.grid,"load",this._onGridReady,this,{single:!0}):(this._onGridLoad(),this.center(),void(Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this))):void this.mon(this.grid,"afterrender",this._onGridReady,this,{single:!0})},_onGridLoad:function(){if(this.getSelectedRef()){var a=this.grid.getStore().find("_ref",this.getSelectedRef());if(-1!==a){var b=this.grid.getStore().getAt(a);this.grid.getSelectionModel().select(b)}}},_getSelectedRecords:function(){return this.selectionModel.getSelection()},_search:function(){var a,b=this.down("#searchTerms").getValue(),c=this.down("#filterTypeComboBox").getValue(),d=this.grid.storeConfig;d.context={project:Rally.getApp().getContext().getProjectRef()},"workspace"==this.searchContext&&(d.context={project:null});var e=this.grid.getStore();e.context=d.context,Ext.isEmpty(b)||(a=Ext.create("Rally.data.wsapi.Filter",{property:c,value:b,operator:"Contains"})),this.grid.filter(a,!0)},_openSearchMenu:function(a){var b=Ext.widget({xtype:"rallymenu",items:[{text:"Search Selected Project",handler:function(){this.searchContext="project",this._search()},scope:this},{text:"Search Everywhere",handler:function(){this.searchContext="workspace",this._search()},scope:this}]});b.showBy(a.getEl()),a.toolTip&&a.toolTip.hide()}}),Ext.define("Rally.technicalservices.CommentButton",{extend:"Rally.ui.Button",requires:["TSUtilities","TSDateUtils","Rally.technicalservices.CommentDialog"],alias:"widget.tscommentbutton",config:{keyPrefix:null},constructor:function(a){if(this.mergeConfig(a),Ext.isEmpty(this.config.keyPrefix))throw"keyPrefix is required for the Comment Button";this.config.text=Ext.String.format("<span class='icon-comment'>{0}</span>",a.text||""),this.callParent([this.config])},afterRender:function(){this.callParent(arguments),this.setDisabled(!0),this._getComments().then({scope:this,success:function(a){this.comments=a,this._setResultCount(),this.mon(this.el,this.clickEvent,this._showDialog,this),this.setDisabled(!1)},failure:function(a){Ext.Msg.alert("Problem loading comments",a)}})},_setResultCount:function(){var a=this.comments.length,b="";b=0===a?Ext.String.format("<span class='icon-comment'>{0}</span>",""):Ext.String.format("<span class='icon-comment'></span> {0}",a),this.setText(b)},_getComments:function(){var a=this.keyPrefix,b={model:"Preference",filters:[{property:"Name",operator:"contains",value:a}],fetch:["Name","Value","CreationDate"]};return TSUtilities.loadWsapiRecords(b)},_showDialog:function(){Ext.create("Rally.technicalservices.CommentDialog",{autoShow:!0,keyPrefix:this.keyPrefix,preferences:this.comments,listeners:{scope:this,commentAdded:function(a,b){this.comments=Ext.Array.merge(this.comments,b),this._setResultCount()},commentRemoved:function(a,b){this.comments=Ext.Array.remove(this.comments,b),this._setResultCount()}}})}}),Ext.define("TSDefaultPreference",{extend:"Ext.data.Model",fields:[{name:"__Preference",type:"object"},{name:"Name",type:"string",convert:function(a,b){return Ext.isEmpty(a)?b&&!Ext.isEmpty(b.get("__Preference"))?b.get("__Preference").get("Name"):Ext.String.format("{0}.{1}",TSUtilities.pinKeyPrefix,Rally.getApp().getContext().getUser().ObjectID):a}},{name:"Value",type:"string",convert:function(a,b){return Ext.isEmpty(a)?b&&!Ext.isEmpty(b.get("__Preference"))?b.get("__Preference").get("Value"):null:a}}],addPin:function(a){var b=a.get("Task"),c=a.get("WorkProduct"),d=c.ObjectID,e=c._type;Ext.isEmpty(b)||(d=b.ObjectID,e="task");var f={type:e,ObjectID:d},g=Ext.Array.merge(this.getPinnedItems(),[f]);return this.set("Value",Ext.JSON.encode(g)),this.save()},removePin:function(a){var b=a.get("_type"),c="",d=-1;if("hierarchicalrequirement"==b||"defect"==b||"task"==b)c=a.get("Name"),d=a.get("ObjectID");else{var e=a.get("Task"),f=a.get("WorkProduct");d=f.ObjectID,c=f._refObjectName,Ext.isEmpty(e)||(d=e.ObjectID,c=e._refObjectName)}var g=Ext.Array.filter(this.getPinnedItems(),function(a){var b=a.ObjectID;return b!=d});return this.set("Value",Ext.JSON.encode(g)),Rally.ui.notify.Notifier.show({message:"Removed Default Item: "+c}),this.save()},isPinned:function(a){var b=a.get("Task"),c=a.get("WorkProduct");if(Ext.isEmpty(c))return!1;var d=c.ObjectID;return Ext.isEmpty(b)||(d=b.ObjectID),Ext.Array.contains(this.getPinnedOIDs(),d)},getPinnedItems:function(){var a=this.get("Value");return Ext.isEmpty(a)?[]:Ext.JSON.decode(a)},getPinnedOIDs:function(){var a=this.getPinnedItems();return Ext.Array.map(a,function(a){return a.ObjectID})},save:function(){var a=Ext.create("Deft.Deferred"),b=this,c=this.get("__Preference");return Ext.isEmpty(c)?this.createPreference():(c.set("Value",b.get("Value")),c.save({callback:function(c,d){d.wasSuccessful()?(b.set("__Preference",c),a.resolve(b)):a.reject(d.error.errors[0])}}),a.promise)},createPreference:function(){var a=Ext.create("Deft.Deferred"),b=this;return Rally.data.ModelFactory.getModel({type:"Preference",success:function(c){var d={Name:b.get("Name"),Value:b.get("Value"),Project:TSUtilities.getPreferenceProject()},e=Ext.create(c,d);e.save({callback:function(c,d){d.wasSuccessful()?(b.set("__Preference",c),a.resolve(b)):a.reject(d.error.errors[0])}})}}),a.promise}}),Ext.define("Rally.technicalservices.TimeModelBuilder",{singleton:!0,deploy_field:"c_IsDeployed",appendKeyPrefix:"rally.technicalservices.timesheet.append",amendKeyPrefix:"rally.technicalservices.timesheet.amend",build:function(a,b){var c=Ext.create("Deft.Deferred"),d=function(a){return Ext.isEmpty(a)?-1:a.ObjectID},e=function(a){return Ext.isEmpty(a)?"":a._refObjectName};return Rally.data.ModelFactory.getModel({type:a,scope:this,success:function(a){var f=a.getFields(),g=a.getField("WorkProduct");g.sortType=d;var h=a.getField("Task");h.sortType=d;var i=[{name:"__FirstTimeEntryItem",type:"object"},{name:"__AllTimeEntryItems",type:"object"},{name:"__WeekStartKey",type:"string"},{name:"__Feature",type:"object",sortType:d},{name:"__Release",type:"object",sortType:e},{name:"__Iteration",type:"object",sortType:e},{name:"__Product",type:"object",sortType:e},{name:"__Total",type:"float",defaultValue:0},{name:"__SecretKey",type:"auto",defaultValue:1},{name:"__Appended",type:"boolean",defaultValue:!1},{name:"__Amended",type:"boolean",defaultValue:!1},{name:"__PrefID",type:"auto",defaultValue:-1},{name:"_ReleaseLockFieldName",type:"string",defaultValue:Rally.technicalservices.TimeModelBuilder.deploy_field},{name:"__Pinned",type:"boolean"}],j=this._getDayFields(),k=Ext.Array.merge(f,j,i),l=Ext.define(b,{extend:"Ext.data.Model",fields:k,addTimeEntryValue:this._addTimeEntryValue,_updateTotal:this._updateTotal,_days:TSDateUtils.getDaysOfWeek(),save:this._save,_saveAsPref:this._saveAsPref,_savePreference:this._savePreference,_saveChangesWithPromise:this._saveChangesWithPromise,getField:this.getField,clearAndRemove:this.clearAndRemove,isLocked:this._isLocked,isPinned:this._isPinned,isDeleted:this._isDeleted,_saveTEV:this._saveTEV,_createTEV:this._createTEV,_getTimeEntryForDayField:this._getTimeEntryForDayField});this.model=l,c.resolve(l)}}),c},getFetchFields:function(){return["ObjectID","Name","Release","User","UserName","Iteration","PlanEstimate","ScheduleState","Estimate","State",this.deploy_field]},_isPinned:function(){return this.get("__Pinned")},_isDeleted:function(){return Ext.isEmpty(this.get("WorkProduct"))?!0:Ext.isEmpty(this.get("Task"))&&!Ext.isEmpty(this.get("TaskDisplayString"))},_isLocked:function(a,b){var c=this.get("__Release"),d=this.get("_ReleaseLockFieldName");return Ext.isEmpty(c)||Ext.isEmpty(d)?!1:c[d]},clearAndRemove:function(){var a=this.get("__AllTimeEntryItems"),b=_.map(TSDateUtils.getDaysOfWeek(),function(a){return Ext.String.format("__{0}",a)});b.push("__Total");var c=this,d=Ext.String.format("{0}.{1}.{2}.{3}",TSUtilities.deletionKeyPrefix,this.get("__WeekStartKey"),this.get("User").ObjectID,(new Date).getTime()),e=this.getData();delete e.__AllTimeEntryItems,Ext.Array.each(b,function(a){delete e[a+"_record"]});var f=Ext.JSON.encode(e);Rally.data.ModelFactory.getModel({type:"Preference",success:function(e){var g={Name:d,Value:f,Project:TSUtilities.getPreferenceProject()},h=Ext.create(e,g);h.save({callback:function(d,e){if(e.wasSuccessful()){if(Ext.Array.each(b,function(a){c.set(a,0)},c),c.get("__PrefID")>0){var f=c.get("__PrefID");Rally.data.ModelFactory.getModel({type:"Preference",success:function(a){a.load(f,{fetch:["Name","ObjectID","Value"],callback:function(a,b){b.wasSuccessful()&&a.destroy()}})}})}else _.each(a,function(a){!Ext.isEmpty(a)&&a.data.ObjectID>0&&a.destroy()});c.destroy()}else Ext.Msg.alert("Problem removing",e.error.errors[0])}})}})},_saveAsPref:function(){var a=this,b=this.get("Task")||this.get("WorkProduct"),c=Rally.technicalservices.TimeModelBuilder.appendKeyPrefix;this.get("__Amended")&&(c=Rally.technicalservices.TimeModelBuilder.amendKeyPrefix);var d=Ext.String.format("{0}.{1}.{2}.{3}",c,this.get("__WeekStartKey"),this.get("User").ObjectID,b.ObjectID),e=Ext.JSON.encode(this.getData());this.get("Project").ObjectID;Rally.data.ModelFactory.getModel({type:"Preference",success:function(b){var c={Name:d,Value:e,Project:TSUtilities.getPreferenceProject()},f=Ext.create(b,c);f.save({callback:function(b,c){c.wasSuccessful()?(a.set("ObjectID",b.get("ObjectID")),a.set("__PrefID",b.get("ObjectID"))):Ext.Msg.alert("Problem amending",c.error.errors[0])}})}})},_savePreference:function(a){var b=this.get("__PrefID"),c=this;Rally.data.ModelFactory.getModel({type:"Preference",success:function(a){a.load(b,{fetch:["Name","ObjectID","Value"],callback:function(a,b){b.wasSuccessful()&&(a.set("Value",Ext.JSON.encode(c.getData())),a.save({callback:function(a,b){b.wasSuccessful()||Ext.Msg.alert("Problem saving change",b.error.errors[0])}}))}})}})},_saveTEV:function(a){var b=Ext.create("Deft.Deferred");return a.save({callback:function(){b.resolve()}}),b.promise},_createTEV:function(a,b,c,d,e,f,g){var h=Ext.create("Deft.Deferred"),i=this;return Rally.data.ModelFactory.getModel({type:"TimeEntryValue",scope:this,success:function(d){var f=d.getFields();Ext.Array.each(f,function(a,b){"TimeEntryItem"==a.name&&(a.readOnly=!1,a.persist=!0,a.type="string"),"DateVal"==a.name&&(f[b]=Ext.create("Rally.data.wsapi.Field",{type:"string",readOnly:!1,persist:!0,name:"DateVal",custom:!1,hidden:!1,useNull:!1}))}),src=Ext.create(d,{Hours:e,TimeEntryItem:{_ref:c.get("_ref")},DateVal:TSDateUtils.getUtcIsoForLocalDate(g,!0)}),src.save({callback:function(c,d){if(!d.wasSuccessful())throw b.set(a,null),"Problem saving time entry value";b.set(a,c),i._updateTotal(),h.resolve()}})}}),h.promise},_saveChangesWithPromise:function(){var a=Ext.create("Deft.Deferred"),b=this,c=this.getChanges();b.modified={};var d=[];return Ext.Object.each(c,function(a,c){var e=this,f=e.getField(a),g=f.__src;if(!Ext.isEmpty(g)){var h=this.get(g);if(Ext.isEmpty(h)){var i=this._getTimeEntryForDayField(f),j=f.__index,k=i.get("WeekStartDate"),l=Rally.util.DateTime.add(k,"day",j);d.push(function(){return b._createTEV(g,e,i,j,c,k,l)})}else h.set("Hours",c),b._updateTotal(),d.push(function(){return b._saveTEV(h)})}},this),0===d.length?(a.resolve(),a):(this.process=Deft.Chain.sequence(d).then({success:function(b){a.resolve(b)},failures:function(b){a.reject(b)}}),a)},_save:function(a){var b=Ext.create("Deft.Deferred");return(this.get("__Amended")||this.get("__Appended"))&&-1==this.get("ObjectID")&&this._saveAsPref(),this.get("__Appended")||this.get("__Amended")?void this._savePreference(changes):(this.process&&"pending"==this.process.getState()?this.process.then({scope:this,success:function(a){b=this._saveChangesWithPromise()},failure:function(a){b.reject(a)}}):this._saveChangesWithPromise().then({scope:this,success:function(a){b.resolve(a)},failure:function(a){b.reject(a)}}),b.promise)},getField:function(a){var b=this.fields.items,c=null;return Ext.Array.each(b,function(b){(b.name==a||b.displayName==a)&&(c=b)}),c},_updateTotal:function(){var a=0;Ext.Array.each(TSDateUtils.getDaysOfWeek(),function(b){var c=this.get(Ext.String.format("__{0}",b))||0;a+=c},this),this.set("__Total",a)},_addTimeEntryValue:function(a){var b=a.get("DateVal").getUTCDay(),c=a.get("Hours"),d=TSDateUtils.getDaysOfWeek()[b],e=Rally.technicalservices.TimeModelBuilder._getDayNumberFieldName(d),f=Rally.technicalservices.TimeModelBuilder._getDayRecordFieldName(d);this.set(e,c),this.set(f,a),this._updateTotal(),this.dirty=!1,this.modified=[]},_getDayNumberFieldName:function(a){return Ext.String.format("__{0}",a)},_getDayNameFromDayField:function(a){return a.slice(2)},_getDayRecordFieldName:function(a){return Ext.String.format("__{0}_record",a)},_getDayFields:function(){var a=TSDateUtils.getDaysOfWeek(),b=[];return Ext.Array.each(a,function(a,c){b.push({name:Rally.technicalservices.TimeModelBuilder._getDayNumberFieldName(a),type:"auto",defaultValue:0,__src:Rally.technicalservices.TimeModelBuilder._getDayRecordFieldName(a),__index:c}),b.push({name:Rally.technicalservices.TimeModelBuilder._getDayRecordFieldName(a),type:"object",defaultValue:null})},this),b},_getTimeEntryForDayField:_.memoize(function(a){var b,c=Rally.technicalservices.TimeModelBuilder._getDayNameFromDayField(a.name),d=TSDateUtils.getDaysOfWeek(),e=d.indexOf(c),f=d.indexOf("Sunday");return b=0===f?this.get("__AllTimeEntryItems")[0]:f>e?this.get("__AllTimeEntryItems")[0]:this.get("__AllTimeEntryItems")[1]},function(a){return TSDateUtils.startDayOfWeek+a.name})}),Ext.override(Rally.ui.grid.plugin.Validation,{_onBeforeEdit:function(a,b,c){}}),Ext.define("Rally.technicalservices.TimeTable",{extend:"Ext.Container",alias:"widget.tstimetable",mixins:["Ext.state.Stateful"],logger:new Rally.technicalservices.Logger,rows:[],columns:null,cls:"tstimetable",time_entry_item_fetch:void 0,config:{localWeekStartDate:null,editable:!0,timesheet_user:null,timesheet_status:null,manager_field:null,week_locked:!1},stateId:"ca.technicalservices.extended.timesheet.columns",stateful:!0,stateEvents:["columnresize"],getState:function(){var a=null;return a={columns:this.columns}},applyState:function(a){a&&Ext.apply(this,a)},constructor:function(a){this.time_entry_item_fetch=["WeekStartDate","WorkProductDisplayString","WorkProduct","Requirement","Task","TaskDisplayString",TSUtilities.lowestPortfolioItemTypeName,"Project","ObjectID","Name","Release"],this.mergeConfig(a),(Ext.isEmpty(a.localWeekStartDate)||!Ext.isDate(a.localWeekStartDate))&&window.alert("Rally.technicalservices.TimeTable requires localWeekStartDate parameter (JavaScript Date)"),this.callParent([this.config])},initComponent:function(){var a=this;this.callParent(arguments),this.addEvents("gridReady"),this.utcWeekStartString=TSDateUtils.getUtcIsoForLocalDate(this.localWeekStartDate),this.utcSundayWeekStartStrings=TSDateUtils.getUtcSundayWeekStartStrings(this.localWeekStartDate),Ext.isEmpty(this.timesheet_user)&&(this.timesheet_user=Rally.getApp().getContext().getUser()),Deft.Chain.sequence([a._getTEIModel,function(){return Rally.technicalservices.TimeModelBuilder.build("TimeEntryItem","TSTableRow")},a._loadPortfolioItemModel],this).then({scope:this,success:function(a){this._updateData()},failure:function(a){Ext.Msg.alert("Problem creating model",a)}})},_getTEIModel:function(){var a=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"TimeEntryItem",scope:this,success:function(b){this.tei_model=b,a.resolve(b)}}),a.promise},_updateData:function(){this.setLoading("Loading time...");var a=this;Deft.Chain.sequence([this._loadTimeEntryItems,this._loadTimeEntryValues,this._loadTimeEntryAppends,this._loadTimeEntryAmends,this._loadDefaultPreference],this).then({scope:this,success:function(b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4];this.timePreference=Ext.create("TSDefaultPreference"),g.length>0&&(this.timePreference=Ext.create("TSDefaultPreference",{__Preference:g[0]}));var h=c;h=TSUtilities.groupTimeEntryItemsByWorkProduct(c);var i=_.map(h,function(b){var c=b[0],d=_.sortBy(b,function(a){return a.WeekStartDate}),e=c.get("Project"),f=c.get("WorkProduct"),g=null,h=null,i=null;if(!Ext.isEmpty(f)){e=f.Project;var j;if(f[TSUtilities.lowestPortfolioItemTypeName])j=f[TSUtilities.lowestPortfolioItemTypeName];else if(f.Requirement){var k=f.Requirement;j=k[TSUtilities.lowestPortfolioItemTypeName]}j&&(g=j,e=g.Project),f.Release&&(h=f.Release),f.Iteration&&(i=f.Iteration)}var l={__WeekStartKey:this.utcWeekStartString,__AllTimeEntryItems:d,__Feature:g,__Iteration:i,__Product:e,__Release:h,__Pinned:a._isItemPinned(c)};return Ext.create("TSTableRow",Ext.Object.merge(l,c.getData()))},this),i=this._addTimeEntryValues(i,d),j=this._getAppendedRowsFromPreferences(e),k=this._getAmendedRowsFromPreferences(f);this.rows=Ext.Array.merge(i,j,k),this._makeGrid(this.rows),this.setLoading(!1)}})},_loadPortfolioItemModel:function(){return Rally.data.ModelFactory.getModel({type:"PortfolioItem/"+TSUtilities.lowestPortfolioItemTypeName,success:function(a){this.portfolio_item_model=a},scope:this})},_getAppendedRowsFromPreferences:function(a){return Ext.Array.map(a,function(a){var b=Ext.JSON.decode(a.get("Value"));b.ObjectID=a.get("ObjectID"),b.__PrefID=a.get("ObjectID");var c=Ext.create("TSTableRow",b);return c.set("updatable",!0),c})},_getAmendedRowsFromPreferences:function(a){return Ext.Array.map(a,function(a){var b=Ext.JSON.decode(a.get("Value"));b.ObjectID=a.get("ObjectID"),b.__PrefID=a.get("ObjectID");var c=Ext.create("TSTableRow",b);return c.set("updatable",!0),c})},_addTimeEntryValues:function(a,b){var c={};return Ext.Array.each(a,function(a){c[a.get("ObjectID")]=a}),Ext.Array.each(b,function(a){var b=a.get("TimeEntryItem").ObjectID,d=c[b];d.addTimeEntryValue(a)}),a},_getTimeEntryItemFilter:function(){var a=Rally.getApp().getContext().getUser().ObjectID;Ext.isEmpty(this.timesheet_user)||(a=this.timesheet_user.ObjectID);var b=Rally.data.wsapi.Filter.or(_.map(this.utcSundayWeekStartStrings,function(a){return{property:"WeekStartDate",value:a}})),c=new Rally.data.wsapi.Filter({property:"User.ObjectID",value:a});return c.and(b)},_getTimeEntryValueFilter:function(){var a=Rally.getApp().getContext().getUser().ObjectID;Ext.isEmpty(this.timesheet_user)||(a=this.timesheet_user.ObjectID);var b=Rally.data.wsapi.Filter.or(_.map(this.utcSundayWeekStartStrings,function(a){return{property:"TimeEntryItem.WeekStartDate",value:a}})),c=new Rally.data.wsapi.Filter({property:"TimeEntryItem.User.ObjectID",value:a});return c.and(b)},_loadTimeEntryItems:function(){this.setLoading("Loading time entry items...");var a={model:"TimeEntryItem",context:{project:null},fetch:Ext.Array.merge(Rally.technicalservices.TimeModelBuilder.getFetchFields(),this.time_entry_item_fetch,[this.manager_field],TSUtilities.fetchManagerPortfolioItemFields),filters:this._getTimeEntryItemFilter()};return TSUtilities.loadWsapiRecords(a)},_loadTimeEntryValues:function(){this.setLoading("Loading time entry values...");var a={model:"TimeEntryValue",context:{project:null},fetch:["DateVal","Hours","TimeEntryItem","ObjectID"],filters:this._getTimeEntryValueFilter()};return TSUtilities.loadWsapiRecords(a)},_getPreferenceFilter:function(){var a=Rally.getApp().getContext().getUser().ObjectID;Ext.isEmpty(this.timesheet_user)||(a=this.timesheet_user.ObjectID);var b=_.map(this.utcSundayWeekStartStrings,function(b){var c=Ext.String.format("{0}.{1}.{2}",Rally.technicalservices.TimeModelBuilder.appendKeyPrefix,b.replace(/T.*$/,""),a);return{property:"Name",operator:"contains",value:c}});return b},_loadTimeEntryAppends:function(){this.setLoading("Loading time entry additions...");var a={model:"Preference",context:{project:null},fetch:["Name","Value","ObjectID"],filters:this._getPreferenceFilter()};return TSUtilities.loadWsapiRecords(a)},_loadTimeEntryAmends:function(){this.setLoading("Loading time entry amendments...");var a={model:"Preference",context:{project:null},fetch:["Name","Value","ObjectID"],filters:this._getPreferenceFilter()};return TSUtilities.loadWsapiRecords(a)},getDefaultPreference:function(){return this.timePreference},_loadDefaultPreference:function(){this.setLoading("Loading preference information...");var a=Rally.getApp().getContext().getUser().ObjectID;Ext.isEmpty(this.timesheet_user)||(a=this.timesheet_user.ObjectID);var b=Ext.String.format("{0}.{1}",TSUtilities.pinKeyPrefix,a),c={model:"Preference",context:{project:null},fetch:["Name","Value","ObjectID"],filters:[{property:"Name",operator:"contains",value:b}]};return TSUtilities.loadWsapiRecords(c)},_makeGrid:function(a){this.removeAll();var b=Ext.create("Rally.data.custom.Store",{model:"TSTableRow",groupField:"__SecretKey",data:a,pageSize:100}),c=this;this.grid=this.add({xtype:"rallygrid",store:b,columnCfgs:this.getColumns(),showPagingToolbar:!1,showRowActionsColumn:!1,sortableColumns:!0,disableSelection:!0,enableColumnMove:!1,enableColumnResize:!0,viewConfig:{listeners:{itemupdate:function(a,b){},viewready:c._addTooltip}},features:[{ftype:"groupingsummary",startCollapsed:!1,hideGroupedHeader:!0,groupHeaderTpl:" ",enableGroupingMenu:!1}],listeners:{scope:this,columnresize:function(a,b,c){Ext.Array.each(this.columns,function(a){a.dataIndex==b.dataIndex&&(a.width=b.width)}),this.fireEvent("columnresize",this.columns)}}}),this.fireEvent("gridReady",this,this.grid)},_addTooltip:function(a){this.toolTip=Ext.create("Ext.tip.ToolTip",{target:a.el,delegate:a.cellSelector,trackMouse:!0,renderTo:Ext.getBody(),listeners:{beforeshow:function(b){var c=b.triggerElement,d=b.triggerElement.parentElement,e=a.getHeaderByCell(c).text,f=a.getHeaderByCell(c).dataIndex,g=a.getRecord(d);if(!g)return!1;var h=null,i=g.get(f);return"Work Product"!=e||Ext.isEmpty(i)||(h=i.Project&&i.Project._refObjectName),Ext.isEmpty(h)?!1:void b.update("<b>Project:</b> "+h)}}})},_isForCurrentUser:function(){return this.timesheet_user.ObjectID==Rally.getApp().getContext().getUser().ObjectID},absorbTime:function(a){var b=Ext.clone(a).getData();if(a.clearAndRemove(),b.__Appended)return this._absorbAppended(b);var c=this.getRowForAmendedRow(b);return Ext.isEmpty(c)?this._absorbAppended(b):this._absorbAmended(b)},_absorbAmended:function(a){var b=Ext.create("Deft.Deferred"),c=_.map(TSDateUtils.getDaysOfWeek(),function(a){return Ext.String.format("__{0}",a)});c.push("__Total");var d=this.getRowForAmendedRow(a);return Ext.Array.each(c,function(b){var c=(a[b]||0,d.get(b)||0),e=c+a[b];0>e&&(e=0),e>24&&(e=24),d.set(b,e)}),d.save().then({success:function(a){b.resolve(a)},failure:function(a){b.reject(a)}}),b.promise},_absorbAppended:function(a){var b=Ext.create("Deft.Deferred"),c=this,d=a.Task;return Ext.isEmpty(d)&&(d=a.WorkProduct),this._getItemFromRef(d._ref).then({success:function(d){c.addRowForItem(d,!0).then({scope:this,success:function(c){var d=_.map(TSDateUtils.getDaysOfWeek(),function(a){return Ext.String.format("__{0}",a)});d.push("__Total"),Ext.Array.each(d,function(b){a[b]>0&&c.set(b,a[b])}),c.save().then({success:function(a){b.resolve(a)},failure:function(a){b.reject(a)}})},failure:function(a){b.reject(a)}})},failure:function(a){b.reject(a)}}),b.promise},pinTime:function(a){this.updatePinProcess&&"pending"===this.updatePinProcess.getState(),this.updatePinProcess=this.timePreference.addPin(a),this.updatePinProcess.then({success:function(){a.set("__Pinned",!0)},failure:function(a){Ext.Msg.alert("Problem saving pin:",a)}})},unpinTime:function(a){var b=Ext.create("Deft.Deferred");return this.updatePinProcess&&"pending"===this.updatePinProcess.getState(),this.updatePinProcess=this.timePreference.removePin(a),this.updatePinProcess.then({success:function(){a.set("__Pinned",!1),b.resolve(a)},failure:function(a){b.reject(a)}}),b.promise},_isItemPinned:function(a){return Ext.isEmpty(this.timePreference)?!1:this.timePreference.isPinned(a)},_getItemFromRef:function(a){var b=Ext.create("Deft.Deferred"),c=a.split(/\//),d=c.pop(),e=c.pop();return Rally.data.ModelFactory.getModel({type:e,success:function(a){a.load(d,{fetch:["Name","FormattedID","Project","ObjectID","WorkProduct"],callback:function(a,c){c.wasSuccessful()&&b.resolve(a)}})}}),b.promise},cloneForAppending:function(a){var b=this,c=a.get("WorkProduct");Ext.isEmpty(a.get("Task"))||(c=a.get("Task"));var d=c._type,e=c.ObjectID;Rally.data.ModelFactory.getModel({type:d,success:function(a){a.load(e,{fetch:["Name","FormattedID","Project","ObjectID","WorkProduct",TSUtilities.lowestPortfolioItemTypeName],callback:function(a,c){c.wasSuccessful()&&(a.set("__Amended",!0),b.addRowForItem(a))}})}})},getRowForAmendedRow:function(a){var b=a.Task;Ext.isEmpty(b)&&(b=a.WorkProduct);for(var c=null,d=[],e=this.grid.getStore().data.items.length,f=0;e>f;f++)d.push(this.grid.getStore().getAt(f));return Ext.Array.each(d,function(a){if(a&&!a.get("__Amended")&&a.get("WorkProduct")){var d=a.get("Task")&&a.get("Task").ObjectID,e=a.get("WorkProduct").ObjectID;(d==b.ObjectID||e==b.ObjectID)&&(c=a)}}),c},addRowForItem:function(a,b){var c=this,d=Ext.create("Deft.Deferred");if(!b&&this._hasRowForItem(a));else{var e=a.get("_type"),f={WorkProductDisplayString:a.get("FormattedID")+":"+a.get("Name"),WorkProduct:{_refObjectName:a.get("Name"),_ref:a.get("_ref"),ObjectID:a.get("ObjectID")},User:{_ref:"/user/"+this.timesheet_user.ObjectID,ObjectID:this.timesheet_user.ObjectID}};if(a.get("Project")&&(f.Project=a.get("Project")),"task"==e)f.TaskDisplayString=a.get("FormattedID")+":"+a.get("Name"),f.Task={_ref:a.get("_ref"),_refObjectName:f.TaskDisplayString,ObjectID:a.get("ObjectID")},f.WorkProductDisplayString=a.get("WorkProduct").FormattedID+":"+a.get("WorkProduct").Name,f.WorkProduct={_refObjectName:a.get("WorkProduct").Name,_ref:a.get("WorkProduct")._ref,ObjectID:a.get("WorkProduct").ObjectID};else if("defect"==e){var g=a.get("Requirement");g&&(f.WorkProductDisplayString=g.FormattedID+":"+g.Name,f.WorkProduct={_refObjectName:g.Name,_ref:g._ref,ObjectID:g.ObjectID})}if(!this._isForCurrentUser()){f.ObjectID=-1,f._type="timeentryitem",f._refObjectUUID=-1;var h=_.map(this.utcSundayWeekStartStrings,function(a){return f.WeekStartDate=a,Ext.create(this.tei_model,f)}),i={__WeekStartKey:this.utcWeekStartString,__FirstTimeEntryItem:h[0],__AllTimeEntryItems:h,__Feature:null,__Iteration:f.WorkProduct.Iteration,__Product:f.Project,__Release:f.WorkProduct.Release};a.get("__Amended")?i.__Amended=!0:i.__Appended=!0;var j=Ext.create("TSTableRow",Ext.Object.merge(i,f));return j.save(),j.set("updatable",!0),c.grid.getStore().loadRecords([j],{addRecords:!0}),c.rows.push(j),j}var k=Ext.Array.merge(Rally.technicalservices.TimeModelBuilder.getFetchFields(),this.time_entry_item_fetch),l=_.map(this.utcSundayWeekStartStrings,function(a){f.WeekStartDate=a;var b=Ext.create(this.tei_model,f);return b.save({fetch:k}).then(function(a){return{savedTimeEntryItem:a,origTimeEntryItem:b}})},this);Deft.promise.Promise.all(l).then({scope:this,success:function(a){var b=a[0].savedTimeEntryItem,e=b.get("Project"),f=b.get("WorkProduct"),g=null,h=null,i=null;Ext.isEmpty(f)||(f[TSUtilities.lowestPortfolioItemTypeName]&&(g=f[TSUtilities.lowestPortfolioItemTypeName],e=g.Project),f.Release&&(h=f.Release),f.Iteration&&(i=f.Iteration));var j={__WeekStartKey:this.utcWeekStartString,__FirstTimeEntryItem:b,__AllTimeEntryItems:_.pluck(a,"savedTimeEntryItem"),__Feature:g,__Iteration:i,__Product:e,__Release:h,__Pinned:c._isItemPinned(b)||!1},k=Ext.create("TSTableRow",Ext.Object.merge(j,a[0].origTimeEntryItem.getData()));c.grid.getStore().loadRecords([k],{addRecords:!0}),c.rows.push(k),d.resolve(k)},failure:function(){Ext.Msg.alert("Problem saving time:",operation.error.errors.join(" ")),d.reject()}})}return d.promise},_hasRowForItem:function(a){for(var b=a.get("_type"),c=a.get("__Amended"),d=!1,e=[],f=this.grid.getStore().data.items.length,g=0;f>g;g++)e.push(this.grid.getStore().getAt(g));return Ext.Array.each(e,function(e){e&&("task"==b?e.get("Task")&&e.get("Task")._ref==a.get("_ref")&&(c&&e.get("__Amended")||!c)&&(d=!0):Ext.isEmpty(e.get("Task"))&&e.get("WorkProduct")&&e.get("WorkProduct")._ref==a.get("_ref")&&(c&&e.get("__Amended")||!c)&&(d=!0))}),d},getColumns:function(){var a=this,b=[],c=!this._isForCurrentUser();this.week_locked&&(c=!1),(this.editable||c)&&b.push({xtype:"tstimetablerowactioncolumn",forModification:c,_csvIgnoreRender:!0}),Ext.Array.push(b,[{dataIndex:"__FirstTimeEntryItem",text:"User",editor:null,hidden:!0,_selectable:!1,renderer:function(a){return a.get("User").UserName}},{dataIndex:"__FirstTimeEntryItem",text:"Week Start",editor:null,hidden:!0,_selectable:!1,renderer:function(a){return a.get("WeekStartDate")}},{dataIndex:"__FirstTimeEntryItem",text:"Locked",editor:null,hidden:!0,_selectable:!1,renderer:function(a,b,c){return c.isLocked()||!1}}]),a.manager_field&&b.push({dataIndex:"__FirstTimeEntryItem",text:"Manager",align:"center",hidden:!0,_selectable:!1,renderer:function(b){return b.get("User")[a.manager_field]||"none"}}),(a.timesheet_status||a.timesheet_status===!1)&&Ext.Array.push(b,[{dataIndex:"__Product",text:"Status",_selectable:!0,renderer:function(b){return a.timesheet_status}}]),Ext.Array.push(b,[{text:"",width:25,_selectable:!1,renderer:function(a,b,c){var d="";return c.isLocked()&&(d+="<span class='icon-lock'> </span>"),c.get("__Appended")&&(d+="<span class='red icon-edit'> </span>"),c.get("__Amended")&&(d+="<span class='red icon-history'> </span>"),d},_csvIgnoreRender:!0},{dataIndex:"__Product",text:"Product",_selectable:!0,flex:1,editor:null,renderer:function(a,b,c){return Ext.isEmpty(a)?"":a._refObjectName},summaryRenderer:function(){return"Totals"}},{dataIndex:"__Feature",text:TSUtilities.lowestPortfolioItemTypeName,flex:1,editor:null,_selectable:!0,renderer:function(a){return Ext.isEmpty(a)?"":Ext.String.format("<a target='_blank' href='{0}'>{1}</a>",Rally.nav.Manager.getDetailUrl(a),a._refObjectName)},exportRenderer:function(a,b,c){return Ext.isEmpty(a)?"":a._refObjectName}}],Ext.Array.map(TSUtilities.fetchManagerPortfolioItemFields,function(a){var b=a;if(this.portfolio_item_model){var c=this.portfolio_item_model.getField(a);c&&(b=c.displayName)}return{text:TSUtilities.lowestPortfolioItemTypeName+" "+b,xtype:"templatecolumn",sortable:!1,tpl:"{__Feature."+a+"}",flex:1,editor:null,_selectable:!0}},this),[{dataIndex:"WorkProduct",text:"Work Product",flex:1,editor:null,_selectable:!0,renderer:function(a,b,c){return Ext.isEmpty(a)?c.get("WorkProductDisplayString"):Ext.String.format("<a target='_blank' href='{0}'>{1}</a>",Rally.nav.Manager.getDetailUrl(a),c.get("WorkProductDisplayString"))},exportRenderer:function(a,b,c){return c.get("WorkProductDisplayString")}},{text:"Work Product Estimate",xtype:"templatecolumn",sortable:!1,tpl:"{WorkProduct.PlanEstimate}",
_selectable:!0,flex:1,editor:null},{text:"Work Product Schedule State",xtype:"templatecolumn",sortable:!1,tpl:"{WorkProduct.ScheduleState}",_selectable:!0,flex:1,editor:null},{dataIndex:"Task",text:"Task",flex:1,editor:null,_selectable:!0,renderer:function(a,b,c){return Ext.isEmpty(a)?c.get("TaskDisplayString"):Ext.String.format("<a target='_blank' href='{0}'>{1}</a>",Rally.nav.Manager.getDetailUrl(a),c.get("TaskDisplayString"))},exportRenderer:function(a,b,c){return c.get("TaskDisplayString")}},{text:"Task Estimate",xtype:"templatecolumn",sortable:!1,tpl:"{Task.Estimate}",_selectable:!0,flex:1,editor:null},{text:"Task State",xtype:"templatecolumn",sortable:!1,tpl:"{Task.State}",_selectable:!0,flex:1,editor:null},{dataIndex:"__Release",text:"Release",flex:1,editor:null,_selectable:!0,renderer:function(a){return Ext.isEmpty(a)?"":a._refObjectName}},{text:"Iteration",xtype:"templatecolumn",dataIndex:"__Iteration",tpl:"{WorkProduct.Iteration.Name}",_selectable:!0,flex:1,editor:null}]);var d=50,e=function(b,c){if(b&&b.isLocked())return!1;var d=0;b&&b.get("__Amended")&&(d=-24);var e=!a.editable;return b&&(b.get("__Appended")||b.get("__Amended"))&&(e=!1),Ext.create("Ext.grid.CellEditor",{field:Ext.create("Rally.ui.NumberField",{xtype:"rallynumberfield",minValue:d,maxValue:24,disabled:e,selectOnFocus:!0,listeners:{change:function(a,b,c){Ext.isEmpty(b)&&a.setValue(0)}}})})};return _.each(TSDateUtils.getDaysOfWeek(),function(a){b.push({dataIndex:Ext.String.format("__{0}",a),width:d,resizable:!1,_selectable:!0,text:a.substr(0,3),align:"center",getEditor:e,summaryType:"sum",field:{},tdCls:a.toLowerCase()})}),b.push({dataIndex:"__Total",width:d,resizable:!1,text:"Total",align:"center",editor:null,_selectable:!0,summaryType:"sum",summaryRenderer:function(a,b,c){return 40>a&&(b.tdCls="total not-enough-hours"),a},tdCls:"ts-total-cell"}),this.columns=this._applyUnsavableColumnAttributes(b),this.columns},_applyUnsavableColumnAttributes:function(a){if(!Ext.isEmpty(this.columns)){var b={};return Ext.Array.each(a,function(a){b[a.dataIndex]=a}),Ext.Array.each(this.columns,function(a){var c=b[a.dataIndex];a.width&&a.width>0&&(a.flex=null),c&&c.renderer&&(a.renderer=c.renderer),c&&c.summaryRenderer&&(a.summaryRenderer=c.summaryRenderer),c&&c.editor&&(a.editor=c.editor),c&&c.getEditor&&(a.getEditor=c.getEditor),c&&c.summaryType&&(a.summaryType=c.summaryType),c&&c.exportRenderer&&(a.exportRenderer=c.exportRenderer),c&&c._selectable&&(a._selectable=c._selectable)}),this.columns}return a},getGrid:function(){return this.down("rallygrid")}}),Ext.define("TSTimesheet",{extend:"Ext.data.Model",statics:{STATUS:{UNKNOWN:"Unknown",ALL:"ALL",NOT_SUBMITTED:"Not Submitted",SUBMITTED:"Submitted",APPROVED:"Approved",PROCESSED:"Processed"}},fields:[{name:"__UserName",type:"object"},{name:"__Hours",type:"float",defaultValue:0},{name:"__Status",type:"string",defaultValue:"Unknown"},{name:"User",type:"object"},{name:"WeekStartDate",type:"date"},{name:"__LastUpdateBy",type:"object"},{name:"__LastUpdateDate",type:"date"},{name:"__Comments",type:"object"}],isSelectable:function(){return!0},getPreferenceKey:function(){return Ext.String.format("{0}.{1}.{2}.{3}",TSUtilities.approvalKeyPrefix,TSDateUtils.getUtcIsoForLocalDate(this.get("WeekStartDate")),this.get("User").ObjectID,(new Date).getTime())},getShortPreferenceKey:function(){return Ext.String.format("{0}.{1}.{2}",TSUtilities.approvalKeyPrefix,TSDateUtils.getUtcIsoForLocalDate(this.get("WeekStartDate")),this.get("User").ObjectID)},_setStatus:function(a){var b=Ext.create("Deft.Deferred"),c=Rally.getApp().getContext().getUser(),d={_type:"User",_ref:c._ref,_refObjectName:c._refObjectName};this.set("__Status",a),this.set("__LastUpdateBy",d._refObjectName);var e=this.getPreferenceKey(),f={status:a,status_date:new Date,status_owner:d};return Deft.Chain.sequence([function(){return this._archivePreferences(this.getShortPreferenceKey())},function(){return this._makePreference(e,Ext.JSON.encode(f))}],this).then({scope:this,success:function(a){b.resolve(a[0])},failure:function(a){Ext.Msg.alert("Failed to save week lock state to "+e,a)}}),b.promise},submit:function(){return this._setStatus(TSTimesheet.STATUS.SUBMITTED)},unsubmit:function(){return this._setStatus(TSTimesheet.STATUS.NOT_SUBMITTED)},approve:function(){return this._setStatus(TSTimesheet.STATUS.APPROVED)},unapprove:function(){return this._setStatus(TSTimesheet.STATUS.NOT_SUBMITTED)},process:function(){return this._setStatus(TSTimesheet.STATUS.PROCESSED)},unprocess:function(){return this._setStatus(TSTimesheet.STATUS.APPROVED)},_archivePreferences:function(a){var b=Ext.create("Deft.Deferred"),c=this,d=[{property:"Name",operator:"contains",value:a},{property:"Name",operator:"!contains",value:TSUtilities.archiveSuffix}],e={model:"Preference",limit:1/0,filters:d,fetch:["Name","Value"]};return TSUtilities.loadWsapiRecords(e).then({scope:this,success:function(a){var d=[];Ext.Array.each(a,function(a){a.set("Project",Rally.getApp().getSetting("preferenceProjectRef")),a.set("Name",a.get("Name")+"."+TSUtilities.archiveSuffix),d.push(function(){return c._savePreference(a)})},this),Deft.Chain.sequence(d).then({success:function(a){b.resolve(a)},failure:function(a){b.reject(a)}})},failure:function(a){b.reject(a)}}),b.promise},_savePreference:function(a){var b=Ext.create("Deft.Deferred");return a.save({callback:function(a,c){c.wasSuccessful()?b.resolve(a):b.reject("Could not archive old status")}}),b.promise},_makePreference:function(a,b){var c=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"Preference",success:function(d){var e={Name:a,Value:b};e.Project=Rally.getApp().getSetting("preferenceProjectRef");var f=Ext.create(d,e);f.save({callback:function(a,b){b.wasSuccessful()?c.resolve([a]):c.reject(b.error.errors.join(". "))}})}}),c.promise}}),Ext.define("Rally.technicalservices.ApproveMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.tsapprovemenuitem",config:{text:"Approve",records:null},constructor:function(a){a=a||{},a.predicate=a.predicate||this.shouldShowMenuItem,a.handler=a.handler||this._approveRecords,this.initConfig(a),this.callParent([a]),this.records&&0!=this.records.length||(this.records=[this.record])},shouldShowMenuItem:function(a){return Ext.Array.every(this.records,function(a){return this._isApprovable(a)},this)},_isApprovable:function(a){return a.get("__Status")&&a.get("__Status")===TSTimesheet.STATUS.SUBMITTED},_approveRecord:function(a){return a?void a.approve():void Ext.Msg.alert("Problem approving record","Can't find record")},_approveRecords:function(){Ext.Array.each(this.records,function(a){this._approveRecord(a)},this)}}),Ext.define("Rally.technicalservices.ProcessMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.tsprocessmenuitem",config:{text:"Process",records:null},constructor:function(a){a=a||{},a.predicate=a.predicate||this.shouldShowMenuItem,a.handler=a.handler||this._processRecords,this.initConfig(a),this.callParent([a]),this.records&&0!=this.records.length||(this.records=[this.record])},shouldShowMenuItem:function(a){return TSUtilities._currentUserCanProcess()&&Ext.Array.every(this.records,function(a){return this._isProcessable(a)},this)},_isProcessable:function(a){return a.get("__Status")&&(a.get("__Status")==TSTimesheet.STATUS.APPROVED||a.get("__Status")==TSTimesheet.STATUS.SUBMITTED)},_processRecord:function(a){return a?void a.process():void Ext.Msg.alert("Problem processing record","Can't find record")},_processRecords:function(){Ext.Array.each(this.records,function(a){this._processRecord(a)},this)}}),Ext.define("Rally.technicalservices.UnapproveMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.tsunapprovemenuitem",config:{text:"Unapprove",records:null},constructor:function(a){a=a||{},a.predicate=a.predicate||this.shouldShowMenuItem,a.handler=a.handler||this._unapproveRecords,this.initConfig(a),this.callParent([a]),this.records&&0!=this.records.length||(this.records=[this.record])},shouldShowMenuItem:function(a){return Ext.Array.every(this.records,function(a){return this._isUnapprovable(a)},this)},_isUnapprovable:function(a){return a.get("__Status")&&a.get("__Status")==TSTimesheet.STATUS.APPROVED},_unapproveRecord:function(a){return a?void a.unapprove():void Ext.Msg.alert("Problem unapproving record","Can't find record")},_unapproveRecords:function(){Ext.Array.each(this.records,function(a){this._unapproveRecord(a)},this)}}),Ext.define("Rally.technicalservices.UnprocessMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.tsunprocessmenuitem",config:{text:"Unprocess",records:null},constructor:function(a){a=a||{},a.predicate=a.predicate||this.shouldShowMenuItem,a.handler=a.handler||this._unprocessRecords,this.initConfig(a),this.callParent([a]),this.records&&0!=this.records.length||(this.records=[this.record])},shouldShowMenuItem:function(a){return TSUtilities._currentUserCanUnprocess()&&Ext.Array.every(this.records,function(a){return this._isUnprocessable(a)},this)},_isUnprocessable:function(a){return a.get("__Status")&&a.get("__Status")==TSTimesheet.STATUS.PROCESSED},_unprocessRecord:function(a){return a?void a.unprocess():void Ext.Msg.alert("Problem unprocessing record","Can't find record")},_unprocessRecords:function(){Ext.Array.each(this.records,function(a){this._unprocessRecord(a)},this)}}),Ext.define("Rally.technicalservices.TimeApprovalRecordMenu",{extend:"Rally.ui.menu.RecordMenu",alias:"widget.tstimeapprovalrecordmenu",config:{record:null,owningEl:void 0},initComponent:function(){this.items=this._getMenuItems(),this.callParent(arguments)},_getMenuItems:function(){var a=this.getRecord(),b=this.records||[a],c=[];this.popoverPlacement||Rally.ui.popover.Popover.DEFAULT_PLACEMENT;return c.push({xtype:"tsapprovemenuitem",view:this.view,record:a,records:b}),c.push({xtype:"tsunapprovemenuitem",view:this.view,record:a,records:b}),c.push({xtype:"tsprocessmenuitem",view:this.view,record:a,records:b}),c.push({xtype:"tsunprocessmenuitem",view:this.view,record:a,records:b}),c}}),Ext.override(Rally.ui.grid.CheckboxModel,{_recordIsSelectable:function(a){return!0}}),Ext.define("Rally.technicalservices.grid.RowActionColumn",{extend:"Ext.grid.column.Column",alias:"widget.tsrowactioncolumn",inheritableStatics:{getRequiredFetchFields:function(a){return a.enableBulkEdit&&["Project","Tags"]||[]}},sortable:!1,hideable:!1,resizable:!1,draggable:!1,menuDisabled:!0,flex:-1,minWidth:Ext.isIE9?22:26,maxWidth:Ext.isIE9?22:26,printable:!1,tdCls:"rally-cell-row-action",cls:"row-action-column-header",config:{rowActionsFn:null,scope:null},constructor:function(){this.callParent(arguments),this.renderer=this._renderGearIcon},initComponent:function(){this.callParent(arguments),this.on("click",this._showMenu,this)},onDestroy:function(){this.menu&&(this.menu.destroy(),delete this.menu),this.callParent(arguments)},_renderGearIcon:function(a,b,c){return b.tdCls=Rally.util.Test.toBrowserTestCssClass("row-action",Rally.util.Ref.getOidFromRef(c.get("_ref"))),'<div class="row-action-icon icon-gear"/>'},_showMenu:function(a,b){var c,d=a.getRecord(Ext.fly(b).parent("tr")),e=a.getSelectionModel().getSelection();a.panel;c={view:a,record:d,records:e,owningEl:b.parentElement,popoverPlacement:["bottom","top"]},this.rowActionsFn?this.menu=Ext.create("Rally.technicalservices.TimeApprovalRecordMenu",Ext.apply({items:this.rowActionsFn.call(this.scope||this,d)},c)):this.menu=this._getDefaultRecordMenu(d,c),this.menu.showBy(Ext.fly(b).down(".row-action-icon"))},_getDefaultRecordMenu:function(a,b){var c=Ext.merge(b,this.menuOptions||{});return Ext.create("Rally.technicalservices.TimeApprovalRecordMenu",c)}}),Ext.override(Ext.selection.CheckboxModel,{onHeaderClick:function(a,b,c){var d=this.view;if(d.features[0].expandAll(),b.isCheckerHd){c.stopEvent();var e=this,f=b.el.hasCls(Ext.baseCSSPrefix+"grid-hd-checker-on");e.preventFocus=!0,f?e.deselectAll():e.selectAll(),delete e.preventFocus}}}),Ext.define("Rally.technicalservices.ManagerDetailDialog",{extend:"Rally.ui.dialog.Dialog",autoShow:!0,closable:!0,layout:"border",config:{record:null,commentKeyPrefix:"",manager_field:null},constructor:function(a){this.mergeConfig(a),this.callParent([this.config]),this.task_fetch_fields=["ObjectID","Name","FormattedID","WorkProduct","Project",TSUtilities.lowestPortfolioItemTypeName,"State","Iteration","Estimate"],this.defect_fetch_fields=["ObjectID","Name","FormattedID","Requirement","Project",TSUtilities.lowestPortfolioItemTypeName,"State","Iteration","Estimate"],this.story_fetch_fields=["WorkProduct",TSUtilities.lowestPortfolioItemTypeName,"Project","ObjectID","Name","Release","PlanEstimate","ScheduleState"]},initComponent:function(){this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this._loadWeekLockPreference().then({scope:this,success:function(a){if(a.length>0){var b=a[0].get("Value"),c=Ext.JSON.decode(b),d=!1;"Locked"==c.status&&(d=!0)}this.record.set("__Locked",d),this.add({xtype:"tstimetable",region:"center",layout:"fit",localWeekStartDate:this.record.get("WeekStartDate"),week_locked:d,editable:!1,manager_field:this.manager_field,timesheet_user:this.record.get("User")}),this.addDocked({xtype:"container",dock:"bottom",layout:"hbox",itemId:"popup_selector_box",padding:10,items:[{xtype:"container",itemId:"popup_left_box"},{xtype:"container",flex:1},{xtype:"container",itemId:"popup_right_box"}]}),this._addSelectors()},failure:function(a){Ext.Msg.alert("Problem finding lock",a)}})},_addSelectors:function(){var a=this.record.get("__Status"),b=this.record.get("__Locked"),c=Ext.String.format("{0}.{1}.{2}",this.commentKeyPrefix,TSDateUtils.formatShiftedDate(this.record.get("WeekStartDate"),"Y-m-d"),this.record.get("User").ObjectID),d=this.down("#popup_left_box");d.add({xtype:"rallybutton",text:'+<span class="icon-task"> </span>',disabled:a==TSTimesheet.STATUS.APPROVED||b,toolTipText:"Search and add Tasks",listeners:{scope:this,click:this._findAndAddTask}}),d.add({xtype:"rallybutton",text:'+<span class="icon-defect"> </span>',disabled:a==TSTimesheet.STATUS.APPROVED||b,toolTipText:"Search and add Defects",listeners:{scope:this,click:this._findAndAddDefect}}),d.add({xtype:"rallybutton",text:'+<span class="icon-story"> </span>',toolTipText:"Search and add User Stories",disabled:a==TSTimesheet.STATUS.APPROVED||b,listeners:{scope:this,click:this._findAndAddStory}}),d.add({xtype:"tscommentbutton",toolTipText:"Read/Add Comments",keyPrefix:c}),this.down("#popup_right_box").add({xtype:"rallybutton",text:"Unapprove",disabled:a!=TSTimesheet.STATUS.APPROVED||b,listeners:{scope:this,click:function(){this._unapproveTimesheet(this.record),this.close()}}}),this.down("#popup_right_box").add({xtype:"rallybutton",text:"Approve",disabled:a!=TSTimesheet.STATUS.SUBMITTED,listeners:{scope:this,click:function(){this._approveTimesheet(this.record),this.close()}}}),this.down("#popup_right_box").add({xtype:"rallybutton",itemId:"export_button",cls:"secondary",text:'<span class="icon-export"> </span>',listeners:{scope:this,click:function(){this._export()}}})},_loadWeekLockPreference:function(){var a=Ext.String.format("{0}.{1}",TSUtilities.timeLockKeyPrefix,TSDateUtils.formatShiftedDate(this.record.get("WeekStartDate"),"Y-m-d")),b=[{property:"Name",operator:"contains",value:a},{property:"Name",operator:"!contains",value:TSUtilities.archiveSuffix}],c={model:"Preference",limit:1,pageSize:1,filters:b,fetch:["Name","Value"],sorters:[{property:"CreationDate",direction:"DESC"}]};return TSUtilities.loadWsapiRecords(c)},_approveTimesheet:function(a){a.approve()},_unapproveTimesheet:function(a){a.unapprove()},_findAndAddTask:function(){var a=this.down("tstimetable"),b=Ext.Array.merge(Rally.technicalservices.TimeModelBuilder.getFetchFields(),this.task_fetch_fields);a&&Ext.create("Rally.technicalservices.ChooserDialog",{artifactTypes:["task"],autoShow:!0,multiple:!0,title:"Choose Task(s)",filterableFields:[{displayName:"Formatted ID",attributeName:"FormattedID"},{displayName:"Name",attributeName:"Name"},{displayName:"WorkProduct",attributeName:"WorkProduct.Name"},{displayName:"Release",attributeName:"Release.Name"},{displayName:"Project",attributeName:"Project.Name"},{displayName:"Owner",attributeName:"Owner"},{displayName:"State",attributeName:"State"}],columns:[{text:"ID",dataIndex:"FormattedID"},"Name","WorkProduct","Release","Project","Owner","State"],storeConfig:{filters:[{property:"Release."+Rally.technicalservices.TimeModelBuilder.deploy_field,operator:"!=",value:!0}]},fetchFields:b,listeners:{artifactchosen:function(b,c){Ext.isArray(c)||(c=[c]),Ext.Array.each(c,function(b){a.addRowForItem(b)})},scope:this}})},_findAndAddDefect:function(){var a=this.down("tstimetable"),b=Ext.Array.merge(Rally.technicalservices.TimeModelBuilder.getFetchFields(),this.defect_fetch_fields);a&&Ext.create("Rally.technicalservices.ChooserDialog",{artifactTypes:["defect"],autoShow:!0,multiple:!0,title:"Choose Defect(s)",filterableFields:[{displayName:"Formatted ID",attributeName:"FormattedID"},{displayName:"Name",attributeName:"Name"},{displayName:"Requirement",attributeName:"Requirement.Name"},{displayName:"Release",attributeName:"Release.Name"},{displayName:"Project",attributeName:"Project.Name"},{displayName:"Owner",attributeName:"Owner"},{displayName:"State",attributeName:"State"}],columns:[{text:"ID",dataIndex:"FormattedID"},"Name","Requirement","Release","Project","Owner","State"],storeConfig:{filters:[{property:"Release."+Rally.technicalservices.TimeModelBuilder.deploy_field,operator:"!=",value:!0}]},fetchFields:b,listeners:{artifactchosen:function(b,c){Ext.isArray(c)||(c=[c]),Ext.Array.each(c,function(b){a.addRowForItem(b)})},scope:this}})},_findAndAddStory:function(){var a=this.down("tstimetable");a&&Ext.create("Rally.technicalservices.ChooserDialog",{artifactTypes:["hierarchicalrequirement"],autoShow:!0,title:"Choose Story(ies)",multiple:!0,filterableFields:[{displayName:"Formatted ID",attributeName:"FormattedID"},{displayName:"Name",attributeName:"Name"},{displayName:TSUtilities.lowestPortfolioItemTypeName,attributeName:TSUtilities.lowestPortfolioItemTypeName+".Name"},{displayName:"Release",attributeName:"Release.Name"},{displayName:"Project",attributeName:"Project.Name"},{displayName:"Owner",attributeName:"Owner"},{displayName:"State",attributeName:"ScheduleState"}],columns:[{text:"ID",dataIndex:"FormattedID"},"Name","WorkProduct","Release","Project","Owner","ScheduleState"],fetchFields:Ext.Array.merge(Rally.technicalservices.TimeModelBuilder.getFetchFields(),this.story_fetch_fields),listeners:{artifactchosen:function(b,c){Ext.isArray(c)||(c=[c]),Ext.Array.each(c,function(b){a.addRowForItem(b)})},scope:this}})},_export:function(){var a=this.down("tstimetable").getGrid(),b=this;if(a){var c=Ext.String.format("manager-detail-report.csv");this.setLoading("Generating CSV"),Deft.Chain.sequence([function(){return Rally.technicalservices.FileUtilities.getCSVFromGrid(this,a)}]).then({scope:this,success:function(a){a&&a.length>0?Rally.technicalservices.FileUtilities.saveCSVToFile(a,c):Rally.ui.notify.Notifier.showWarning({message:"No data to export"})}}).always(function(){b.setLoading(!1)})}}}),Ext.define("TSTimeSheetApproval",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},layout:"border",items:[{xtype:"container",itemId:"selector_box",region:"north",layout:{type:"hbox"}},{xtype:"container",itemId:"display_box",region:"center",layout:{type:"fit"}}],_commentKeyPrefix:"rally.technicalservices.timesheet.comment",integrationHeaders:{name:"TSTimeSheetApproval"},stateFilterValue:TSTimesheet.STATUS.SUBMITTED,config:{defaultSettings:{managerField:"DisplayName",showAllForAdmins:!0,preferenceProjectRef:"/project/51712374295",fetchManagerPortfolioItemFields:void 0}},launch:function(){var a=this.getSetting("preferenceProjectRef"),b=this.getSetting("fetchManagerPortfolioItemFields");"string"===Ext.typeOf(b)?TSUtilities.fetchManagerPortfolioItemFields=""!=b?b.split(","):[]:"array"===Ext.typeOf(b)&&(TSUtilities.fetchManagerPortfolioItemFields=b),TSUtilities.lowestPortfolioItemTypeName=this.getSetting("lowestPortfolioItemTypeName"),TSUtilities.isEditableProjectForCurrentUser(a,this)?TSUtilities.lowestPortfolioItemTypeName?this._addSelectors(this.down("#selector_box")):Ext.Msg.alert("Contact your Administrator","This app requires the lowest level Portfolio Item Type to be set."):Ext.Msg.alert("Contact your Administrator","This app requires editor access to the preference project.")},_addSelectors:function(a){a.removeAll(),a.add({xtype:"rallybutton",cls:"secondary",text:'<span class="icon-expandall"> </span>',expanded:!1,listeners:{scope:this,click:function(a){if(1==a.expanded){a.expanded=!1,a.setText('<span class="icon-expandall"> </span>');var b=this.down("rallygrid");b&&b.getView().features[0].collapseAll()}else{a.expanded=!0,a.setText('<span class="icon-collapseall"> </span>');var b=this.down("rallygrid");b&&b.getView().features[0].expandAll()}}}}),a.add({xtype:"rallybutton",itemId:"export_button",cls:"secondary",text:'<span class="icon-export"> </span>',disabled:!0,listeners:{scope:this,click:function(){this._export()}}});var b=Ext.create("Ext.data.Store",{fields:["displayName","value"],data:[{displayName:"All",value:TSTimesheet.STATUS.ALL},{displayName:"Not Submitted",value:TSTimesheet.STATUS.NOT_SUBMITTED},{displayName:"Submitted",value:TSTimesheet.STATUS.SUBMITTED},{displayName:"Approved",value:TSTimesheet.STATUS.APPROVED},{displayName:"Processed",value:TSTimesheet.STATUS.PROCESSED}]});a.add({xtype:"container",flex:1}),a.add({xtype:"combobox",value:this.stateFilterValue,fieldLabel:"Timesheet State:",store:b,queryMode:"local",displayField:"displayName",valueField:"value",margin:10,width:200,listeners:{scope:this,change:function(a){this.stateFilterValue=a.getValue(),this._enableGoButton()}}});var c=a.add({xtype:"container",layout:"vbox",margin:3}),d=Rally.util.DateTime.add(new Date,"week",-4);c.add({xtype:"rallydatefield",itemId:"from_date_selector",fieldLabel:"From Week",listeners:{scope:this,change:function(a,b){var c=TSDateUtils.getBeginningOfWeekForLocalDate(b);Ext.Date.isEqual(c,b)?this._enableGoButton():a.setValue(c)}}}).setValue(d),c.add({xtype:"rallydatefield",itemId:"to_date_selector",fieldLabel:"Through Week",listeners:{scope:this,change:function(a,b){var c=TSDateUtils.getBeginningOfWeekForLocalDate(b);Ext.Date.isEqual(c,b)?this._enableGoButton():a.setValue(c)}}}).setValue(Rally.util.DateTime.add(new Date,"week",-1)),a.add({xtype:"rallybutton",itemId:"go_button",text:"Go",margin:"15 3 3 3",disabled:!1,listeners:{scope:this,click:this._updateData}}),a.add({xtype:"container",flex:1}),a.add({type:"container",html:"&nbsp;&nbsp;&nbsp;",border:0,padding:10})},_enableGoButton:function(){var a=this.down("#from_date_selector"),b=this.down("#to_date_selector"),c=this.down("#go_button");c&&c.setDisabled(!0),a&&b&&c&&c.setDisabled(!1)},_updateData:function(){var a=this;this.down("#display_box").removeAll(),this.down("#go_button").setDisabled(!0),this.startDate=this.down("#from_date_selector").getValue(),this.endDate=this.down("#to_date_selector").getValue(),this.pipeline&&"pending"===this.pipeline.getState()&&this.pipeline.cancel(),this.pipeline=Deft.Chain.pipeline([this._loadTimesheets,this._loadPreferences,this._loadComments],this),this.pipeline.then({scope:this,success:function(a){this._addGrid(this.down("#display_box"),a)},failure:function(a){Ext.Msg.alert("Problem loading users with timesheets",a)}}).always(function(){a.setLoading(!1)})},_loadTimesheets:function(){var a=Ext.create("Deft.Deferred");this.setLoading("Loading timesheets...");var b=[{property:"User.Disabled",value:!1}];if(this.down("#from_date_selector")){var c=TSDateUtils.getUtcIsoForLocalDate(this.startDate,!0);b.push({property:"WeekStartDate",operator:">=",value:c})}if(this.down("#to_date_selector")){var c=TSDateUtils.getUtcIsoForLocalDate(this.endDate,!0);b.push({property:"WeekStartDate",operator:"<=",value:c})}if(!this.getSetting("showAllForAdmins")||!TSUtilities.currentUserIsAdmin()){var d=this.getContext().getUser().UserName;b.push({property:"User."+this.getSetting("managerField"),operator:"contains",value:d})}var e={model:"TimeEntryItem",limit:"Infinity",filters:b,context:{project:null},fetch:["User","WeekStartDate","ObjectID","UserName","Values:summary[Hours]",this.getSetting("managerField")]};return TSUtilities.loadWsapiRecords(e).then({scope:this,success:function(b){var c={};Ext.Array.each(b,function(a){var b=Ext.String.format("{0}_{1}",a.get("User").ObjectID,Rally.util.DateTime.toIsoString(a.get("WeekStartDate")));c[b]||(c[b]=Ext.Object.merge(a.getData(),{__UserName:a.get("User").UserName,__Hours:0,__Status:TSTimesheet.STATUS.UNKNOWN}));var d=c[b].__Hours||0;c[b].__Hours=this._addHoursFromTimeEntryItem(d,a)},this),a.resolve(Ext.Array.map(Ext.Object.getValues(c),function(a){return Ext.create("TSTimesheet",a)})),this.setLoading(!1)},failure:function(b){a.reject(b)}}),a.promise},_loadPreferences:function(a){var b=Ext.create("Deft.Deferred");this.setLoading("Loading statuses...");var c=this.stateFilterValue,d=[{property:"Name",operator:"contains",value:TSUtilities.approvalKeyPrefix},{property:"Name",operator:"!contains",value:TSUtilities.archiveSuffix}],e={model:"Preference",limit:"Infinity",filters:d,fetch:["Name","Value"],sorters:[{property:"CreationDate",direction:"ASC"}]};return TSUtilities.loadWsapiRecords(e).then({scope:this,success:function(d){var e={};Ext.Array.each(d,function(a){var b=a.get("Name").split(".");b.pop(),e[b.join(".")]=a}),Ext.Array.each(a,function(a){var b=a.getShortPreferenceKey();if(e[b]){var c=e[b].get("Value"),d={};d=/{/.test(c)?Ext.JSON.decode(c):{status:c,status_owner:{_refObjectName:""}},a.set("__Status",d.status||TSTimesheet.STATUS.NOT_SUBMITTED),a.set("__LastUpdateBy",d.status_owner._refObjectName||"")}else a.set("__Status",TSTimesheet.STATUS.NOT_SUBMITTED)},this);var f=Ext.Array.filter(a,function(a){return c===TSTimesheet.STATUS.ALL?!0:a.get("__Status")===c});this.setLoading(!1),b.resolve(f)},failure:function(a){b.reject(a)}}),b.promise},_loadComments:function(a){var b=Ext.create("Deft.Deferred"),c=this;this.setLoading("Loading comments...");var d={},e=Ext.Array.map(a,function(a){var b=Ext.String.format("{0}.{1}.{2}",c._commentKeyPrefix,TSDateUtils.formatShiftedDate(a.get("WeekStartDate"),"Y-m-d"),a.get("User").ObjectID);return d[b]=a,{property:"Name",operator:"contains",value:b}}),f=[];return Ext.Array.each(e,function(a){var b={model:"Preference",limit:"Infinity",filters:[a],fetch:["Name","Value"],context:{project:null}};f.push(function(){return TSUtilities.loadWsapiRecords(b)})}),CA.techservices.promise.ParallelThrottle.throttle(f,6,c).then({success:function(a){var c=Ext.Array.flatten(a);Ext.Array.each(c,function(a){var b=a.get("Name").split(/\./);b.pop();var c=b.join("."),e=d[c];if(!Ext.isEmpty(e)){var f=e.get("__Comments");Ext.isEmpty(f)&&(f=[]),f.push(a),e.set("__Comments",f)}}),b.resolve(Ext.Object.getValues(d))},failure:function(a){b.reject(a)}}),b.promise},_addHoursFromTimeEntryItem:function(a,b){var c=b.get("Summary");if(c&&c.Values&&c.Values.Hours){var d=c.Values.Hours;Ext.Object.each(d,function(b,c){a+=b*c})}return a},_addGrid:function(a,b){var c=Ext.create("Rally.data.custom.Store",{data:b,groupField:"User",groupDir:"ASC",pageSize:5e4,model:"TSTimesheet",sorters:[{property:"__UserName"},{property:"WeekStartDate",direction:"DESC"}],getGroupString:function(a){var b=a.get("User");return b&&b._refObjectName||"No Owner"}}),d=this._getColumns();a.add({xtype:"rallygrid",store:c,columnCfgs:d,enableEditing:!1,showRowActionsColumn:!1,enableBulkEdit:!0,showPagingToolbar:!1,features:[{ftype:"groupingsummary",startCollapsed:!0,groupHeaderTpl:"{name} ({rows.length})"}],_recordIsSelectable:function(a){return!0},listeners:{scope:this,itemclick:function(a,b,c,d,e){var f=a.getPositionByEvent(e).column;f>1&&this._popup(b)},viewready:function(){this.down("#export_button")&&this.down("#export_button").setDisabled(!1)},destroy:function(){this.down("#export_button")&&this.down("#export_button").setDisabled(!0)}}})},_getColumns:function(){var a=this,b=[{xtype:"tsrowactioncolumn"}];return b.push({dataIndex:"User",text:"User",renderer:function(a){return a._refObjectName||value.UserName}}),b.push({dataIndex:"WeekStartDate",text:"Week Starting",align:"center",renderer:function(a){return TSDateUtils.formatShiftedDate(a,"m/d/y")}}),b.push({dataIndex:"__Hours",text:"Hours",align:"center",renderer:a._renderColor}),b.push({dataIndex:"__Status",text:"Status",align:"center"}),b.push({dataIndex:"__LastUpdateBy",text:"Status Changed By",align:"center"}),b.push({dataIndex:"User",text:"Manager",align:"center",renderer:function(b){return b[a.getSetting("managerField")]||"none"}}),b.push({dataIndex:"__Comments",text:"Comments",align:"center",renderer:function(a){return Ext.isEmpty(a)?0:Ext.isArray(a)?a.length:0}}),b},_popup:function(a){var b=a.get("User")._refObjectName,c=a.get("__Status");Ext.create("Rally.technicalservices.ManagerDetailDialog",{id:"popup",width:Ext.getBody().getWidth()-150,height:Ext.getBody().getHeight()-150,title:Ext.String.format("{0}: {1} ({2})",b,TSDateUtils.formatShiftedDate(a.get("WeekStartDate"),"j F Y"),c),autoShow:!0,autoCenter:!0,closable:!0,commentKeyPrefix:this._commentKeyPrefix,record:a,manager_field:this.getSetting("managerField")})},_export:function(){var a=this.down("rallygrid"),b=this;if(a){var c="manager-time-report.csv";this.setLoading("Generating CSV");var d=[],e=a.getSelectionModel().getSelection();e&&0!=e.length||d.push(function(){return Rally.technicalservices.FileUtilities.getCSVFromGrid(this,a)}),Ext.Array.each(e,function(a,c){d.push(function(){return b._getCSVFromTimesheet(a,c>0)})}),Deft.Chain.sequence(d).then({scope:this,success:function(a){var b=a.join("\r\n");b&&b.length>0?Rally.technicalservices.FileUtilities.saveCSVToFile(b,c):Rally.ui.notify.Notifier.showWarning({message:"No data to export"})}}).always(function(){b.setLoading(!1)})}},_getCSVFromTimesheet:function(a,b){var c=Ext.create("Deft.Deferred"),d=this;a.get("__Status"),Ext.create("Rally.technicalservices.TimeTable",{localWeekStartDate:a.get("WeekStartDate"),editable:!1,timesheet_status:a.get("__Status"),timesheet_user:a.get("User"),listeners:{scope:this,gridReady:function(a,e){e.getStore().isLoading()?e.getStore().on("load",function(){c.resolve(Rally.technicalservices.FileUtilities.getCSVFromGrid(d,e,b))},this,{single:!0}):c.resolve(Rally.technicalservices.FileUtilities.getCSVFromGrid(this,e,b))}}});return c.promise},_renderColor:function(a,b,c){var d="#ffffff",e="#fec6cd",f="#ffffcc",g="#D0D0D0",h=g;a>=40&&67.51>a&&(h=d),40>a&&(h=f);var i=TSDateUtils.getUtcIsoForLocalDate(c.get("WeekStartDate")),j=TSDateUtils.getUtcIsoForLocalDate(new Date);return j>i&&40>a&&(h=e),b.style="background-color: "+h,a},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},_filterOutExceptStrings:function(a){Rally.getApp();a.filter([{filterFn:function(a){var b=a.get("fieldDefinition").attributeDefinition,c=null;return b&&(c=b.AttributeType),"BOOLEAN"==c?!1:"STRING"!=c||a.get("fieldDefinition").attributeDefinition.Constrained?!1:!0}}])},getSettingsFields:function(){var a=this;return[{name:"showAllForAdmins",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 10",boxLabel:'Show All<br/><span style="color:#999999;"><i>Tick to show all timesheets regardless of manager for admins.</i></span>'},{name:"preferenceProjectRef",xtype:"rallyprojectpicker",fieldLabel:"Preference Project",workspace:this.getContext().getWorkspaceRef(),showMostRecentlyUsedProjects:!1,autoExpand:!0,labelWidth:75,labelAlign:"left",minWidth:200,margin:10},{name:"managerField",xtype:"rallyfieldcombobox",fieldLabel:"User Manager Field",labelWidth:75,labelAlign:"left",minWidth:200,margin:10,autoExpand:!1,alwaysExpanded:!1,model:"User",listeners:{ready:function(b){
a._filterOutExceptStrings(b.getStore())}},readyEvent:"ready"},Ext.merge({labelWidth:75,labelAlign:"left",minWidth:200,margin:10},TSUtilities.lowestPortfolioItemTypeNameSettingField),Ext.merge({labelWidth:75,labelAlign:"left",minWidth:200,margin:10,model:"PortfolioItem/"+TSUtilities.lowestPortfolioItemTypeName},TSUtilities.fetchManagerPortfolioItemFieldsSettingField)]},onSettingsUpdate:function(a){this.launch()}});

               Rally.launchApp('TSTimeSheetApproval', {
                   name: 'timesheet-with-approval (manager-view)'
               });
        });
    </script>

    <style type="text/css">

td.ts-total-cell {
    background-color: #eee !important;
}

.x-grid-row-summary {
    background-color: #eee;
}

.x-grid-row-alt .x-grid-td {
    background-color: #fff;
}

.x-border-layout-ct {
    background-color: #ffffff;
}

td.ts-weekend-cell {
    background-color: #B0E0E6 !important;
}

td.sunday {
    background-color: #B0E0E6 !important;
}

td.saturday {
    background-color: #B0E0E6 !important;
}

td.not-enough-hours {
     background-color: #fec6cd !important;;   
}

span.red {
    color: red;
}
.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}

.x-window {
    border: 2px solid black !important;
}

td.ts-total-cell {
    background-color: #eee !important;
}

.x-grid-row-summary {
    background-color: #eee;
}

td.manager-red {
  color: black;
  background: #fec6cd !important;
}

    </style>

</head>
<body></body>
</html>